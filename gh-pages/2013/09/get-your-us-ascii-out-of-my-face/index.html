<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Primary Unit mirror on GitHub – Get your US-ASCII out of my face</title>

  <!-- Load my combined stylesheet -->
  <link rel="stylesheet" href="/resources/all.min.css">


  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <link rel="alternate" type="application/rss+xml" title="RSS feed for Primary Unit" href="/rss">
  <link rel="alternate" type="application/json" title="JSON feed for Primary Unit" href="/feed.json">

  <!-- Apple pinned sites icon, Apple touch icon, Favicon -->
  <link rel="mask-icon" href="/resources/favicon.svg" color="#1369BF">
  <link rel="apple-touch-icon-precomposed" href="/resources/favicon.png">
  <link rel="icon" href="/resources/favicon.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A mirror of https://www.robjwells.com hosted on GitHub">
</head>

<body>

<div class="wrapper">

<header class="site-header">

  <div class="site-title-container mute-links">
    <h1 class="site-title"><a href="https://robjwells.github.io">Primary Unit mirror on GitHub</a></h1>
    <p class="site-byline"><i>by</i> Rob Wells</p>
  </div>

  <div class="site-menu-container">

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/archives/">Archives</a></li>
        <li><a href="/feed.json">JSON&nbsp;feed</a></li>
        <li><a href="/rss">RSS&nbsp;feed</a></li>
      </ul>
    </nav>

    <label for="search-field" class="site-search-label">
      Site search
    </label>
    <form id="site-search" class="site-search" method="get" action="https://duckduckgo.com/">
      <input name="q" type="text" id="search-field" class="search-field" placeholder="via DuckDuckGo">
      <input name="sites" value="https://robjwells.github.io" hidden>
      <button type="submit" class="search-button">Search</button>
    </form>

  </div> <!-- .site-menu-container -->

</header> <!-- .site-header -->

<main role="main">

  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2013/09/get-your-us-ascii-out-of-my-face/">Get your US-ASCII out of my face</a></h2>
      <p><time datetime="2013-09-14T14:05">Saturday, September 14 2013</time></p>
    </header>
    <div class="flag">
  <p><strong>Warning: The contents of this post may not be up to date!</strong></p>
  <p>Sorry, but if you’re searching for answers about why you can’t reliably set environment variables in OS X (particularly <code>PATH</code>), the information below may be out of date.</p>
  <p>Apple has changed the system so many times in so many different ways it’s difficult to find <em>anything</em> on the internet about this that is correct and up-to-date, so I’ve placed this warning on the top of every post I’ve written about it.</p>
  <p>As of 2017-03-02 it appears that the best collection of information is <a href="https://github.com/ersiner/osx-env-sync">the osx-env-sync project on GitHub</a> and its associated issues.</p>
  <p>Be wary of anything that you find on StackOverflow: the answers there may well have been correct at the time but incorrect now.</p>
  <p>For reference, my own posts on this problem (newest first) are:</p>
  <ul>
    <li><a href="/2017/03/setting-os-xs-environment/">Setting OS X’s environment</a></li>
    <li><a href="/2014/12/locale-in-os-x-whats-the-current-situation/">Locale in OS X — what’s the current situation?</a></li>
    <li><a href="/2014/12/locale-in-os-x-and-launch-agents/">Locale in OS X and Launch Agents</a></li>
    <li><a href="/2013/09/get-your-us-ascii-out-of-my-face/">Get your US-ASCII out of my face</a></li>
  </ul>
</div>

<p>When I was writing the script in <a href="/2013/09/solo-diff/">yesterday’s post</a> I came across this bizarre text encoding problem:</p>
<pre><code>UnicodeDecodeError: 'ascii' codec can't decode byte
0xe2 in position 5: ordinal not in range(128)</code></pre>


<p>Ascii what? We’re all Unicode now, don’t you know? If I’m taking in UTF-8 text, keeping it in a Unicode string, and then writing it out to UTF-8 encoded text files where is goddamn Ascii creeping in?</p>
<p>This first occurred at work, while I was <em>trying to work</em>, so my horrendous hack solution was to switch the temporary files into binary mode and encode the two strings into UTF-8 before writing them out. (This was when the script was still a text filter, so the problem was only on the back end.)</p>
<p>That’s a horrible hack. Bytes! Yuck! So in my next attempt I explicitly opened the files with a UTF-8 encoding. Which was still gross. And totally unnecessary. This is Python 3, everything’s Unicode, all the defaults are UTF-8, why am I having to specify the encoding at every point?</p>
<p>This was the point at which I found <a href="http://stackoverflow.com/questions/5981570/encoding-errors-running-python-from-within-bbedit?rq=1">a relevant Stack Overflow question</a>. Unfortunately the answer there was to tinker with Python’s start-up files in a way that was always discouraged and had since been removed from Python 3.</p>
<p>Hm. But what’s this about <code>sys.setdefaultencoding</code>? So I started poking around with this terrible little script:</p>
<pre><code>#!/usr/bin/env python3
import os
import sys
import locale
entire_file = open(os.environ['BB_DOC_PATH'], 'r')
print(os.environ)
print(entire_file.encoding)
print(sys.getdefaultencoding())
print(locale.getpreferredencoding())</code></pre>


<p>For the last three lines, which print the encodings used, I got:</p>
<pre><code>US-ASCII    # File encoding
utf-8       # sys.getdefaultencoding
US-ASCII    # locale.getpreferredencoding</code></pre>


<p>So the system setting wasn’t the culprit. But why is the system encoding different to the locale, which seems to determine the default encoding with which files are opened?</p>
<p>Locale refers to the environment variables in my Terminal, but when I try <code>echo $LANG</code> it’s set to <code>en_GB.UTF-8</code> — surely that’s not the problem?</p>
<h3>WRONG.</h3>
<p>As <a href="http://www.velocityreviews.com/forums/t695885-print-and-unicode-strings-python-3-1-a.html">this thread</a> eventually made me realise, I didn’t actually have <code>$LANG</code> set to anything — it was all smoke and mirrors that cleared away when I ran the script through BBEdit. (I also had a similar problem with Applescript’s <code>do shell script</code> and it looks like <a href="http://www.sublimetext.com/forum/viewtopic.php?t=13753">Sublime Text users</a> have also run into it.) Checking the <code>os.environ</code> output from the script above confirmed it: no <code>$LANG</code>.</p>
<p>The root of the problem is that if a locale isn’t set it defaults to the C locale — meaning US-ASCII in OS&nbsp;X. <strong>The solution is to explicitly set $LANG in your .bash_profile</strong>:</p>
<pre><code>export LANG=&quot;en_GB.UTF-8&quot;</code></pre>


<p>I’ve also got that line in ~/.bashrc for safety, but do bear in mind that <em>some shells will ignore both</em> ~/.bash_profile and ~/.bashrc.</p>
<p>You could set the other <code>LC_*</code> keywords as well, if you like, but <code>$LANG</code> should be enough according to <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/locale.1.html">the man page for <code>locale</code></a>:</p>
<pre><code>LANG         Used as a substitute for any unset LC_* variable.  If LANG
             is unset, it will act as if set to &quot;C&quot;.  If any of LANG or
             LC_* are set to invalid values, locale acts as if they are
             all unset.</code></pre>


<div class="flag">
  <p><strong>Update 2013-09-21</strong></p>
  <p>I’ve just re-watched <a href="http://nedbatchelder.com/text/unipain.html">Ned Batchelder’s great Pragmatic Unicode video</a> and while setting the <code>$LANG</code> environment variable is a handy solution on your own machines, it’s not a good fit when you’re writing a program that will run on systems where you can’t control the default encoding.</p>
  <p>In such cases it makes sense to adopt his “Unicode sandwich” approach of explicitly decoding I/O and then working on the resulting Unicode.</p>
</div>
  </article>

</main>

<footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> <!-- .site-footer -->

</div> <!-- .wrapper -->

</body>

</html>