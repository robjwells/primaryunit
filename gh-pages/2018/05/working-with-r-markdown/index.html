<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Primary Unit mirror on GitHub – Working with R Markdown</title>

  <!-- Load my combined stylesheet -->
  <link rel="stylesheet" href="/resources/all.min.css">


  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <link rel="alternate" type="application/rss+xml" title="RSS feed for Primary Unit" href="/rss">
  <link rel="alternate" type="application/json" title="JSON feed for Primary Unit" href="/feed.json">

  <!-- Apple pinned sites icon, Apple touch icon, Favicon -->
  <link rel="mask-icon" href="/resources/favicon.svg" color="#1369BF">
  <link rel="apple-touch-icon-precomposed" href="/resources/favicon.png">
  <link rel="icon" href="/resources/favicon.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A mirror of https://www.robjwells.com hosted on GitHub">
</head>

<body>

<div class="wrapper">

<header class="site-header">

  <div class="site-title-container mute-links">
    <h1 class="site-title"><a href="https://robjwells.github.io">Primary Unit mirror on GitHub</a></h1>
    <p class="site-byline"><i>by</i> Rob Wells</p>
  </div>

  <div class="site-menu-container">

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/archives/">Archives</a></li>
        <li><a href="/feed.json">JSON&nbsp;feed</a></li>
        <li><a href="/rss">RSS&nbsp;feed</a></li>
      </ul>
    </nav>

    <label for="search-field" class="site-search-label">
      Site search
    </label>
    <form id="site-search" class="site-search" method="get" action="https://duckduckgo.com/">
      <input name="q" type="text" id="search-field" class="search-field" placeholder="via DuckDuckGo">
      <input name="sites" value="https://robjwells.github.io" hidden>
      <button type="submit" class="search-button">Search</button>
    </form>

  </div> <!-- .site-menu-container -->

</header> <!-- .site-header -->

<main role="main">

  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2018/05/working-with-r-markdown/">Working with R Markdown</a></h2>
      <p><time datetime="2018-05-05T23:55">Saturday, May 5 2018</time></p>
    </header>
    <p>I’ve just published an update to <a href="https://www.robjwells.com/2018/05/3-75-years-on-the-tube/">my recent Tube travel post</a>, fixing a few small mistakes, a bigger one (an error in a station name that nonetheless didn’t affect the plot involved) and adding an update to the last section which goes a bit deeper into the fare and duration difference between the two periods.</p>
<p>I didn’t fix the mistake in the title, as I felt it was too late, but of course it’s 3⅔ years, not 3.75, since September 2014.</p>
<p>
    <video src="/images/2018-05-05-naked-gun-realise-that-now.mp4"
        poster="/images/2018-05-05-naked-gun-realise-that-now.jpg"
        controls
        muted>
        <img
        src="/images/2018-05-05-naked-gun-realise-that-now.jpg"
        alt="“I realise that, now…” from the film Naked Gun">
    </video>
</p>

<p>In that post I mentioned how pleasant it is working in <a href="https://www.rstudio.com/products/RStudio/">R Studio</a> in a <a href="https://rmarkdown.rstudio.com">R Markdown</a> document. It really is, and I find the R Markdown way of mixing prose and code much more natural and fluid than <a href="https://jupyter.org">Jupyter notebooks</a>, which I like the idea of but find the block-based method a bit awkward.</p>
<p>The biggest problem with R Markdown was fitting it into my, admittedly arcane, <a href="https://github.com/robjwells/majestic">blogging system</a>. To do so, I’ve cooked up <a href="https://github.com/robjwells/primaryunit/blob/3be7c91007f10946e60fecb3c2007f85080d3950/posts/2018/04/decode_blocks.py">a short Python script</a> to transform the Markdown output from R Studio and <a href="https://yihui.name/knitr/">knitr</a>.</p>
<p>Right now, I’ve settled on this set of output options in the YAML front-matter:</p>
<pre><code>md_document:
    variant: markdown_strict+fenced_code_blocks
    preserve_yaml: true
    fig_width: 7.5
    fig_height: 5
    dev: svg
    pandoc_args: [
        &quot;--wrap&quot;, &quot;preserve&quot;
    ]</code></pre>


<p>Now I don’t actually use fenced (<code>~~~~</code>) code blocks in Markdown, instead I just use regular Markdown indented code blocks with a header line (<code>python:</code>) at the top. But I include that extension in the Markdown variant to make it easier to transform code blocks later.</p>
<p>But why? Well, if your output just uses indented code blocks, it’s difficult to tell which of those are your R code and which are the R code’s output. Fencing the blocks makes it easier to insert empty comments after each block, keeping code and output separate.</p>
<p>The <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> front matter is preserved as I use a similar thing in my own posts and this gets passed through to my blogging system without a problem, with unknown settings ignored. (I do remove the quoting that the template file includes around strings.)</p>
<p>The other important option above is supplying the <code>--wrap</code> argument to <a href="http://pandoc.org">Pandoc</a>, preserving the line breaks as they are in the source file instead of breaking them. By default Pandoc hard-wraps the lines, which I’d be fine with, except that it hard wraps the alt text for images (plots).</p>
<p>That makes it more difficult to pick out later. This is necessary as I always use HTML to include images in my posts (so I can set classes, allow for full-width etc).</p>
<p>I say more difficult as I’m working line-wise. It’d be possible to apply a regex to the joined lines and make the transformation, but then again I don’t hard-wrap my own posts so it’s not something I care about keeping.</p>
<p>The option I would like to use is to keep my Markdown reference links intact, instead of having Pandoc put everything inline. But this makes the images into reference links, making rewriting more difficult again.</p>
<p>So, I knit the document together from R Studio, then apply <a href="https://github.com/robjwells/primaryunit/blob/3be7c91007f10946e60fecb3c2007f85080d3950/posts/2018/04/decode_blocks.py">the script</a>, and pipe the output into the for-real .md file. This is the one that gets checked into the <a href="https://www.mercurial-scm.org">Mercurial</a> repository, fed into my blog generator and ultimately published.</p>
<p>I could probably get away with doing less, or handling things differently — such as allowing for fenced code on the generator’s side.</p>
<p>But I want the transformed output to resemble as closely as possible something that I’d written in <a href="https://www.barebones.com/products/bbedit/">BBEdit</a> because I actually attach some importance to the contents of the Markdown files outside their use as raw material with which to create HTML.</p>
<p>They should be able to tell the post’s story without needing to be processed further, to interpret R code or make the raw source readable. I’m not quite at the point of having totally pure, completely readable plain text files (note those dummy comments mentioned above) but I want to be as close as I can.</p>
  </article>

</main>

<footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> <!-- .site-footer -->

</div> <!-- .wrapper -->

</body>

</html>