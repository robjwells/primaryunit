<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Primary Unit mirror on GitHub – page 14</title>

  <!-- Load my combined stylesheet -->
  <link rel="stylesheet" href="/resources/all.min.css">

  <!-- Load my combined JavaScript -->
  <script src="/resources/all.min.js" async></script>

  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <link rel="alternate" type="application/rss+xml" title="RSS feed for Primary Unit" href="/rss">
  <link rel="alternate" type="application/json" title="JSON feed for Primary Unit" href="/feed.json">

  <!-- Apple pinned sites icon, Apple touch icon, Favicon -->
  <link rel="mask-icon" href="/resources/favicon.svg" color="#1369BF">
  <link rel="apple-touch-icon-precomposed" href="/resources/favicon.png">
  <link rel="icon" href="/resources/favicon.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A mirror of https://www.robjwells.com hosted on GitHub">
</head>

<body>

<div class="wrapper">

<header class="site-header">

  <div class="site-title-container mute-links">
    <h1 class="site-title"><a href="https://robjwells.github.io">Primary Unit mirror on GitHub</a></h1>
    <p class="site-byline"><i>by</i> Rob Wells</p>
  </div>

  <div class="site-menu-container">

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/archives/">Archives</a></li>
        <li><a href="/feed.json">JSON&nbsp;feed</a></li>
        <li><a href="/rss">RSS&nbsp;feed</a></li>
      </ul>
    </nav>

    <label for="search-field" class="site-search-label">
      Site search
    </label>
    <form id="site-search" class="site-search" method="get" action="https://duckduckgo.com/">
      <input name="q" type="text" id="search-field" class="search-field" placeholder="via DuckDuckGo">
      <input name="sites" value="https://robjwells.github.io" hidden>
      <button type="submit" class="search-button">Search</button>
    </form>

  </div> <!-- .site-menu-container -->

</header> <!-- .site-header -->

<main role="main">

  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2014/12/locale-in-os-x-and-launch-agents/">Locale in OS X and Launch Agents</a></h2>
      <p><time datetime="2014-12-20T15:46">Saturday, December 20 2014</time></p>
    </header>
    <div class="flag">
  <p><strong>Warning: The contents of this post may not be up to date!</strong></p>
  <p>Sorry, but if you’re searching for answers about why you can’t reliably set environment variables in OS X (particularly <code>PATH</code>), the information below may be out of date.</p>
  <p>Apple has changed the system so many times in so many different ways it’s difficult to find <em>anything</em> on the internet about this that is correct and up-to-date, so I’ve placed this warning on the top of every post I’ve written about it.</p>
  <p>As of 2017-03-02 it appears that the best collection of information is <a href="https://github.com/ersiner/osx-env-sync">the osx-env-sync project on GitHub</a> and its associated issues.</p>
  <p>Be wary of anything that you find on StackOverflow: the answers there may well have been correct at the time but incorrect now.</p>
  <p>For reference, my own posts on this problem (newest first) are:</p>
  <ul>
    <li><a href="/2017/03/setting-os-xs-environment/">Setting OS X’s environment</a></li>
    <li><a href="/2014/12/locale-in-os-x-whats-the-current-situation/">Locale in OS X — what’s the current situation?</a></li>
    <li><a href="/2014/12/locale-in-os-x-and-launch-agents/">Locale in OS X and Launch Agents</a></li>
    <li><a href="/2013/09/get-your-us-ascii-out-of-my-face/">Get your US-ASCII out of my face</a></li>
  </ul>
</div>

<p>I really dislike <a href="/2013/09/get-your-us-ascii-out-of-my-face/">last year’s post about ASCII and UTF-8</a>. It’s one of those posts that, when you look back, reveals how little you know about a topic. The stuff in there isn’t all wrong but as a whole it’s not correct.</p>
<p>Towards the end I say that the way to make sure that the locale isn’t <code>C</code> is to export <code>LANG</code> in a bunch of profile/rc files. But that doesn’t work if those files aren’t sourced — quite common when scripts get run on your behalf.</p>
<p>At some point I got bitten again and fixed it using <a href="http://en.wikipedia.org/wiki/Launchd">launchd</a>. By modifying the /etc/launchd.conf configuration file (as suggested <a href="http://www.digitaledgesw.com/node/31">here</a> and <a href="http://stackoverflow.com/questions/135688/setting-environment-variables-in-os-x/">here</a>), you could make launchd set environment variables at startup:</p>
<div class="syntax"><pre><span></span><span class="c1"># /etc/launchd.conf</span>
setenv LANG en_GB.UTF-8
</pre></div>


<p>Dead simple, and ensures that <code>LANG</code> is always correct. But unfortunately useless in Yosemite. From the launchctl man page:</p>
<blockquote>
<p>The /etc/launchd.conf file is no longer consulted for subcommands to run during early boot time; this functionality was removed for security considerations.</p>
</blockquote>
<p>(I should note that I don’t have a clean install of Yosemite, so maybe Apple has fixed the default locale to something <code>*.UTF-8</code> and my carried-over files have got in the way. But I don’t think so: the guest account defaults to the <code>C</code> locale.)</p>
<p>There’s a <a href="http://stackoverflow.com/questions/25385934/setting-environment-variables-via-launchd-conf-no-longer-works-in-os-x-yosemite">thread on Stack Overflow</a> containing some discussion about how to handle the change. It’s a bit of a muddle, but the common theme is to use a real launchd job to set environment variables on startup.</p>
<p>Launchd agents are registered using .plist files (XML), which are a pain to work with by hand, so I recommend <a href="https://www.peterborgapps.com/lingon/">Lingon</a> (nicer to use) or <a href="http://www.soma-zone.com/LaunchControl/">LaunchControl</a> (exposes more settings). The most basic setup is to call launchctl directly:</p>
<p><img alt="Lingon set to run launchctl at startup with the arguments 'setenv LANG en_GB.UTF-8'" src="/images/2014-12-19_locales-lingon-basic.png" /></p>
<p>That’ll save a .plist file in ~/Library/LaunchAgents/ — a job that gets run by launchd when you log in (for your user only). And we’re done!</p>
<p>Setting the locale in this way means that it will be set correctly for any process that follows (even something like <code>do shell script</code> in AppleScript).</p>
<h3>But wait</h3>
<p>Since we’re mucking around with Launch Agents and using launchctl at boot, we can set up the environment however we like. Rather than use launchctl directly, I run my own script that does several things:</p>
<div class="syntax"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch Agent to set environment variables on boot</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="nb">set</span> -e
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="nv">date</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="k">)</span>
<span class="lineno"> 6 </span><span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$date</span><span class="s2">\tSetting environment variables with </span><span class="nv">$0</span><span class="s2">&quot;</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c1"># Locale</span>
<span class="lineno"> 9 </span>launchctl setenv LANG en_GB.UTF-8
<span class="lineno">10 </span>launchctl setenv LC_ALL en_GB.UTF-8
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="c1"># Python</span>
<span class="lineno">13 </span>launchctl setenv PYTHONPATH <span class="s2">&quot;/Users/robjwells/Dropbox/bin&quot;</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span><span class="c1"># Path</span>
<span class="lineno">16 </span><span class="k">if</span> <span class="o">[</span> -x /usr/libexec/path_helper <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">17 </span>  <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="lineno">18 </span>  <span class="nb">eval</span> <span class="k">$(</span>/usr/libexec/path_helper -s<span class="k">)</span>
<span class="lineno">19 </span>  launchctl setenv PATH <span class="nv">$PATH</span>
<span class="lineno">20 </span><span class="k">fi</span>
</pre></div>


<p>It’s largely straightforward: setting the locale correctly, then <code>PYTHONPATH</code> (searched for Python modules), then something more involved for the <code>PATH</code>.</p>
<p>By default, OS X sets <code>PATH</code> to something that’s pretty sparse:</p>
<pre><code>/usr/bin:/bin:/usr/sbin:/sbin</code></pre>


<p>(You can check this with <code>do shell script "echo $PATH"</code> in AppleScript.)</p>
<p>That can make some things pretty difficult, particularly if you want to use scripts you’ve written through some kind of intermediary that doesn’t source your setup files.</p>
<p><a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/path_helper.8.html">path_helper</a> constructs a path from the contents of /etc/paths and files in /etc/paths.d — giving you a much more expansive path than by default (and one you can add to by placing a file of your own in the latter directory). And again, by setting this at boot through launchctl it’s available widely afterwards.</p>
<p>Not everywhere, though. For instance, <a href="http://smilesoftware.com/TextExpander/index.html">TextExpander</a> <a href="http://www.smilesoftware.com/help/TextExpander/applescript.html">ensures UTF-8 support</a> by setting <code>LANG</code>, but <code>PATH</code> is still restricted to the short one listed above. I get the feeling TextExpander is doing more than just inheriting the environment and tweaking <code>LANG</code>.</p>
<h3>‘Legacy subcommands’</h3>
<p>The language in the launchctl man page refers to “the previous implementation of launchd” and Yosemite brings with it a new (painful) interface, with the previous interface listed under the heading “legacy subcommands”. Some of the commands listed there don’t have equivalents in the new interface — including the vital <code>setenv</code>.</p>
<p>I don’t know whether to be worried by the “legacy” description. If these commands go away without similar ones being introduced we could be left without a way to set vital environment variables (fixing Apple’s oversights). But it sounds that launchd has undergone major surgery, so reimplementing the previous interface does suggest some kind of commitment to it, at least in the interim.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2014/12/start-and-end-of-line-shortcuts-in-bbedit/">Start and end of line shortcuts in BBEdit</a></h2>
      <p><time datetime="2014-12-18T00:34">Thursday, December 18 2014</time></p>
    </header>
    <p>I keep BBEdit's option to emulate Emacs key bindings disabled, because I don't know most of them and some of those combinations I want to use for other things.</p>
<p>However, I've been doing more work on the command line recently, and not having ⌃A and ⌃E to move to the start and end of the current line was starting to grate. The cursor keys are just too far away!</p>
<p>So I whipped up some scripts to give me back those shortcuts while keeping the rest of the Emacs stuff disabled.</p>
<h3>Start of line</h3>
<div class="syntax"><pre><span></span><span class="k">set</span> <span class="nv">line_start</span> <span class="k">to</span> <span class="nb">the</span> <span class="nv">characterOffset</span> <span class="k">of</span> <span class="nv">line</span> <span class="p">(</span><span class="nv">startLine</span> <span class="k">of</span> <span class="nb">the</span> <span class="nv">selection</span><span class="p">)</span>
<span class="nb">select</span> <span class="nv">insertion</span> <span class="nv">point</span> <span class="nb">before</span> <span class="nb">character</span> <span class="nv">line_start</span>
</pre></div>


<h3>End of line</h3>
<div class="syntax"><pre><span></span><span class="k">set</span> <span class="nv">current_line</span> <span class="k">to</span> <span class="nv">line</span> <span class="p">(</span><span class="nv">startLine</span> <span class="k">of</span> <span class="nb">the</span> <span class="nv">selection</span><span class="p">)</span>
<span class="k">set</span> <span class="nv">end_of_line</span> <span class="k">to</span> <span class="p">((</span><span class="nv">characterOffset</span> <span class="k">of</span> <span class="nv">current_line</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nv">length</span> <span class="k">of</span> <span class="nv">current_line</span><span class="p">))</span>
<span class="nb">select</span> <span class="nv">insertion</span> <span class="nv">point</span> <span class="nb">before</span> <span class="nb">character</span> <span class="nv">end_of_line</span>
</pre></div>


<p>Wrap both of those in:</p>
<div class="syntax"><pre><span></span><span class="k">tell</span> <span class="nb">application</span> <span class="s2">&quot;BBEdit&quot;</span>
    <span class="k">tell</span> <span class="nb">the</span> <span class="nb">front</span> <span class="nb">text</span> <span class="na">window</span>
        <span class="err">…</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>(omitted above to reduce the amount of scrolling), dump them in ~/Library/Application Support/BBEdit/Scripts/, assign them the ⌃A and ⌃E shortcuts in BBEdit's preferences, and you're all set.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2014/12/solving-boredom-with-four-languages/">Solving boredom with four languages</a></h2>
      <p><time datetime="2014-12-04T00:01">Thursday, December 4 2014</time></p>
    </header>
    <p>At work one of the most tedious jobs is putting all of the stories that appear in the paper onto our website. We're still working from text files (which works very well) as for a number of reasons we haven't yet changed to use the site's CMS as the central location where copy is stored.</p>
<p>So towards the end of the day we have to go through nearly all the pages, strip out the headlines, standfirsts and copy, and input them into the site's backend. It's mindless, slow and frankly demoralising.</p>
<p>A perfect candidate for automation then!</p>
<p>Let's start with taking the text from the InDesign files, with an AppleScript I run through <a href="http://www.red-sweater.com/fastscripts/">FastScripts</a>:</p>
<div class="syntax"><pre><span></span><span class="lineno"> 1 </span><span class="k">tell</span> <span class="nb">application</span> <span class="s2">&quot;Adobe InDesign CS5.5&quot;</span>
<span class="lineno"> 2 </span>  <span class="k">tell</span> <span class="nb">the</span> <span class="nb">front</span> <span class="na">document</span>
<span class="lineno"> 3 </span>    <span class="k">set</span> <span class="nv">the_text</span> <span class="k">to</span> <span class="k">get</span> <span class="nb">the</span> <span class="na">contents</span> <span class="k">of</span> <span class="nb">the</span> <span class="nv">selection</span>
<span class="lineno"> 4 </span>  <span class="k">end</span> <span class="k">tell</span>
<span class="lineno"> 5 </span><span class="k">end</span> <span class="k">tell</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="k">repeat</span> <span class="nv">with</span> <span class="nv">an_item</span> <span class="k">in</span> <span class="nv">the_text</span>
<span class="lineno"> 8 </span>  <span class="nb">do shell script</span> <span class="p">(</span><span class="s2">&quot;echo &#39;&quot;</span> <span class="o">&amp;</span> <span class="nv">an_item</span> <span class="o">&amp;</span> <span class="s2">&quot;&#39; &gt;&gt; ~/Desktop/web_strip.txt&quot;</span><span class="p">)</span>
<span class="lineno"> 9 </span><span class="k">end</span> <span class="k">repeat</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="nb">do shell script</span> <span class="p">(</span><span class="s2">&quot;echo &#39;\\n\\n\\n\\n&#39; &gt;&gt; ~/Desktop/web_strip.txt&quot;</span><span class="p">)</span>
</pre></div>


<p>Here we take the content of the selected InDesign frames and use a shell script snippet to append it to a file on the desktop, followed by a bunch of newlines to separate the appended text.</p>
<p>It's straightforward, but <code>the contents of the selection</code> in line 3 could return anything: more than one selected frame and you get a list, just one and you get whatever data is in the frame. So, instead of iterating over several pieces of text in line 7, you iterate over each character in one piece of text. Bonus points: InDesign CS4 (which we use at work) doesn't preserve the order in which you select frames, meaning you have to go one-by-one (and use a different script — I'm showing the one I use at home here).</p>
<p>Ok, now we've got a text file with all the copy in. Once that's been cleaned up — any unnoticed mistakes corrected, print-focussed formatting removed — it's time to enter it into the CMS.</p>
<p>For ages, this is where the automation stopped. The editor used in the CMS interprets pasted text oddly, requiring people to paste the plain text into (shock horror) TextEdit in rich-text mode, and from there into the field in the CMS. Lots of copying and pasting. Lots of boredom. Gross.</p>
<p>But these are just fields on a web page. And, of course, the page uses jQuery. And Safari lets you <code>do JavaScript</code> through AppleScript. This should be trivial. (Chrome also lets you execute JavaScript through AppleScript, but it threw up a weird error that I couldn't be bothered to dig into.)</p>
<p>A bit of poking around in the inspector revealed that most of the interesting fields could be set through a simple <code>.val(foo)</code> on the element, while the body of the article could be set through <code>.html('bar')</code> — and wrapping paragraphs in <code>&lt;p&gt;</code> tags ensured that the text displayed correctly.</p>
<p>But how to get the text from a file in BBEdit into the fields? We need to use AppleScript to tell Safari to execute JavaScript, but you do not want to do any kind of text processing in AppleScript — nor do you really want to do it by hand for tens of articles.</p>
<p>I decided on a Python text filter. Not entirely appropriate — we don't transform and return the text — but it's a dead simple way of working with the selection and removing it once we're done.</p>
<p>Using Python lets us do all sorts of wonderful things too other than just preparing the InDesign text to be entered into the fields. Here's the code, before I dive in any further:</p>
<div class="syntax"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/usr/local/bin/python3</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="lineno"> 4 </span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Morning Star&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
<span class="lineno"> 7 </span>         <span class="o">...</span>
<span class="lineno"> 8 </span>         <span class="s1">&#39;A Reporter&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span>
<span class="lineno"> 9 </span>         <span class="p">}</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="n">length_lambdas</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lead&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="mi">300</span> <span class="o">&lt;=</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">,</span>
<span class="lineno">13 </span>                           <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="lineno">14 </span>                  <span class="s1">&#39;2ndlead&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">,</span>
<span class="lineno">15 </span>                              <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<span class="lineno">16 </span>                  <span class="s1">&#39;150word&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">,</span>
<span class="lineno">17 </span>                              <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
<span class="lineno">18 </span>                  <span class="s1">&#39;inbrief&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="lineno">19 </span>                              <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
<span class="lineno">20 </span>                  <span class="s1">&#39;splash&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="mi">400</span> <span class="o">&lt;=</span> <span class="n">l</span><span class="p">,</span>
<span class="lineno">21 </span>                             <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
<span class="lineno">22 </span>                  <span class="p">}</span>
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># Dr Drang&#39;s asrun function</span>
<span class="lineno">25 </span><span class="c1"># http://www.leancrew.com/all-this/2013/03/combining-python-and-applescript/</span>
<span class="lineno">26 </span><span class="k">def</span> <span class="nf">asrun</span><span class="p">(</span><span class="n">ascript</span><span class="p">):</span>
<span class="lineno">27 </span>  <span class="s2">&quot;Run the given AppleScript and return the standard output and error.&quot;</span>
<span class="lineno">28 </span>  <span class="n">osa</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;osascript&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">],</span>
<span class="lineno">29 </span>                          <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<span class="lineno">30 </span>                          <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<span class="lineno">31 </span>                          <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
<span class="lineno">32 </span>  <span class="k">return</span> <span class="n">osa</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">ascript</span><span class="o">.</span><span class="n">encode</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">33 </span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="n">text</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="lineno">36 </span><span class="n">head</span><span class="p">,</span> <span class="n">standfirst</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="lineno">37 </span><span class="k">if</span> <span class="ow">not</span> <span class="n">standfirst</span><span class="p">:</span>
<span class="lineno">38 </span>  <span class="n">standfirst</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>           <span class="c1"># Required. Don&#39;t ask</span>
<span class="lineno">39 </span><span class="k">if</span> <span class="ow">not</span> <span class="n">author</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<span class="lineno">40 </span>  <span class="n">author</span> <span class="o">=</span> <span class="s1">&#39;Morning Star&#39;</span>
<span class="lineno">41 </span><span class="k">else</span><span class="p">:</span>
<span class="lineno">42 </span>  <span class="n">author</span> <span class="o">=</span> <span class="n">author</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;by &#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno">43 </span><span class="n">name_id</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="lineno">44 </span><span class="n">words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="lineno">45 </span><span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">length_lambdas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="lineno">46 </span>  <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">](</span><span class="n">words</span><span class="p">):</span>
<span class="lineno">47 </span>    <span class="n">length_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="lineno">48 </span>
<span class="lineno">49 </span><span class="n">wrapped_body</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;/p&gt;&lt;p&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;&lt;/p&gt;&#39;</span>
<span class="lineno">50 </span>
<span class="lineno">51 </span>
<span class="lineno">52 </span><span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="lineno">53 </span><span class="s2">tell application &quot;Safari&quot;</span>
<span class="lineno">54 </span><span class="s2">  tell the front document</span>
<span class="lineno">55 </span><span class="s2">    set js_head to &quot;$(&#39;#articleInputTitle&#39;).val(&#39;</span><span class="si">{head}</span><span class="s2">&#39;)&quot;</span>
<span class="lineno">56 </span><span class="s2">    set js_standfirst to &quot;$(&#39;#articleTextareaSummery&#39;).val(&#39;</span><span class="si">{standfirst}</span><span class="s2">&#39;)&quot;</span>
<span class="lineno">57 </span><span class="s2">    set js_body to &quot;$(&#39;#articleTextareaContent_ifr&#39;).contents().find(&#39;#tinymce&#39;).html(&#39;</span><span class="si">{body}</span><span class="s2">&#39;)&quot;</span>
<span class="lineno">58 </span><span class="s2">    set js_length to &quot;$(&#39;#articleSelectPosition&#39;).val(</span><span class="si">{length}</span><span class="s2">)&quot;</span>
<span class="lineno">59 </span><span class="s2">    set js_author to &quot;$(&#39;#articleSelectAuthor&#39;).val(</span><span class="si">{author}</span><span class="s2">)&quot;</span>
<span class="lineno">60 </span><span class="s2">    do JavaScript js_head</span>
<span class="lineno">61 </span><span class="s2">    do JavaScript js_standfirst</span>
<span class="lineno">62 </span><span class="s2">    do JavaScript js_body</span>
<span class="lineno">63 </span><span class="s2">    do JavaScript js_length</span>
<span class="lineno">64 </span><span class="s2">    do JavaScript js_author</span>
<span class="lineno">65 </span><span class="s2">  end tell</span>
<span class="lineno">66 </span><span class="s2">end tell</span>
<span class="lineno">67 </span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="o">=</span><span class="n">head</span><span class="p">,</span> <span class="n">standfirst</span><span class="o">=</span><span class="n">standfirst</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">wrapped_body</span><span class="p">,</span>
<span class="lineno">68 </span>           <span class="n">length</span><span class="o">=</span><span class="n">length_id</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">name_id</span><span class="p">)</span>
<span class="lineno">69 </span>
<span class="lineno">70 </span><span class="n">asrun</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
<span class="lineno">71 </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>


<p>I like to put data at the top of my scripts and the code beneath, so let's start on line 35, where we read in the text from BBEdit. Line 36 breaks that text apart: I use a four-part structure, where the first line is the headline, then the standfirst and byline (both of which can be blank) and then any remaining lines form the body.</p>
<p>In line 43 we index into the names dictionary (abbreviated to protect the guilty, lines 6–9) using the cleaned-up byline, with 4 the value for the default author. This and the story type stuff below are presented as drop-down menus, which is where the integers come from.</p>
<p>Next we crudely count the words in the body to work out the story type, which are roughly differentiated by length. I iterate over a dictionary of lambdas instead of a lengthy <code>if-elif</code> block, mostly because it lets me use the dictionary keys to store the strings associated with the values. (You could do the same with comments in the <code>if-else</code>. I don't think there's a big advantage to either method.)</p>
<p>Note that the lambda for the 'inbrief' type just returns False. We collect all of the brief stories into a single article on the web, with the total length anything from 100 words to over 600, and I couldn't think of an easy way to pick them out. I set the type for briefs by hand.</p>
<p>The last processing step is to wrap each line of the body with paragraph tags. (It's basic but it works!)</p>
<p>Then we format a string containing the AppleScript, which runs the JavaScript, and pass it to Dr Drang's <a href="http://www.leancrew.com/all-this/2013/03/combining-python-and-applescript/">asrun function</a> for execution.</p>
<p>And finally we print an empty string to delete the current selection in BBEdit — time to move on to the next story.</p>
<p>By using this script and opening up a dozen or two 'new article' tabs in Safari, moving between each one and using the text filter to populate the fields, I can effectively do work in parallel instead of one task at a time — filling in new articles while I wait for the website to catch up and show the publishing time options. And no more copy &amp; paste from TextEdit.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2014/04/mano-al-teclado/">Mano-al-teclado</a></h2>
      <p><time datetime="2014-04-14T23:09">Monday, April 14 2014</time></p>
    </header>
    <p>In a <a href="http://www.leancrew.com/all-this/2014/04/man-page-followup/">follow-up</a> to his <a href="http://www.leancrew.com/all-this/2014/04/oh-man/">man page post</a>, Dr Drang writes that he suspects the people who responded with keyboard-centric methods “were all slightly appalled by the notion of using the mouse or trackpad to bring up a man page.”</p>
<p>No such dismay here. While I generally prefer to keep my hands on the keyboard there are often cases when using the mouse is easier or faster, as explained in the <a href="http://www.asktog.com/TOI/toi06KeyboardVMouse1.html">Bruce Tognazzini article</a> Dr Drang quotes.</p>
<p>Not all keyboard shortcuts are created equal. In my <a href="/2013/11/die-bookmarks-bar-die/">bookmarks bar post</a> I threw out one lot for another, as it was difficult to remember the shortcut for a particular function even though the key combinations were simple (<code>⌘-[1-9]</code>). This led to the situation Tog describes: it took longer to remember the shortcut than it would to use the mouse.</p>
<blockquote>
<p>It takes two seconds to decide upon which special-function key to press.
Deciding among abstract symbols is a high-level cognitive function.
Not only is this decision not boring, the user actually experiences amnesia!
Real amnesia!</p>
</blockquote>
<p>But I think indexes such as <a href="http://www.obdev.at/products/launchbar/index.html">LaunchBar</a> (or <a href="http://help.adobe.com/en_US/indesign/cs/using/WSa285fff53dea4f8617383751001ea8cb3f-6e68a.html#WSE4179F8F-7053-48b4-BFDC-2102D5F27789">InDesign’s quick apply panel</a>) sidestep the problem. Here’s what Tog says about mouse users:</p>
<blockquote>
<p>They have not had to set their task aside to think about or remember abstract symbols.</p>
</blockquote>
<p>That’s remarkably similar to using indexes: after typing a simple shortcut (<code>⌘-Space</code>, <code>⌘-↩</code>) to bring up the panel, a user just has to type their intent. I suspect that cuts down on the decision time substantially.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2014/04/broken-mercurial-dummy-cacerts/">Broken Mercurial dummy cacerts</a></h2>
      <p><time datetime="2014-04-13T09:37">Sunday, April 13 2014</time></p>
    </header>
    <p>When I tried to push <a href="/2014/04/manhandled/">my last post</a> to Bitbucket I received this ugly error:</p>
<pre><code>abort: error: _ssl.c:507: error:14090086:SSL
routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed</code></pre>


<p>Gross as it is, the message is straightforward: the SSL certificate failed to verify. I imagine the root cause is the whole <a href="http://heartbleed.com">OpenSSL mess</a> and everyone reissuing their certificates, but it posed an immediate practical local problem: I couldn’t push to my source control.</p>
<p>Git(hub) seemed to be fine, but any Mercurial commands involving the network — either trying to connect to Bitbucket or Kiln — would fail.</p>
<p>The culprit turned out to be this line in my <code>~/.hgrc</code>:</p>
<pre><code>[web]
cacerts = /etc/hg-dummy-cert.pem</code></pre>


<p>Which, as dumb as it looks, is the <a href="http://mercurial.selenic.com/wiki/CACertificates#Mac_OS_X_10.6_and_higher">recommended way</a> to enable certificate checking through the system keychain.</p>
<p>Regenerating the permissions file didn’t help. Maybe this approach will work again in the future, once the wave of reissued certificates has broken, but for now there’s a straightforward solution:</p>
<ol>
<li>Remove the <code>cacerts</code> line from your <code>hgrc</code>;</li>
<li>Use a Mercurial command such as <code>hg incoming</code> that causes it to wail about
    a server’s certificate not being verified;</li>
<li>Using the details from that message, add a <a href="http://www.selenic.com/mercurial/hgrc.5.html#hostfingerprints"><code>hostfingerprints</code></a>
    section to your <code>hgrc</code>;</li>
<li>Repeat with each server you connect to.</li>
</ol>
<p>You should end up with something like this:</p>
<pre><code>[hostfingerprints]
bitbucket.org = 45:AD:AE:1A:CF:0E:73:47…
robjwells.kilnhg.com = c3:83:2c:5a:2d:0…</code></pre>


<p>See <a href="http://blog.bitbucket.org/2014/04/08/bitbuckets-ssl-certificates-are-changing/">Bitbucket’s post</a> for a few more details.</p>
  </article>
  <div class="pagination">
<p class="pagination-older"><a href="https://robjwells.github.io/page-15/">Older posts</a></p><p class="pagination-newer"><a href="https://robjwells.github.io/page-13/">Newer posts</a></p>  </div>

</main>

<footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> <!-- .site-footer -->

</div> <!-- .wrapper -->

</body>

</html>