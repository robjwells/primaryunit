<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Primary Unit mirror on GitHub – page 16</title>

  <!-- Load my combined stylesheet -->
  <link rel="stylesheet" href="/resources/all.min.css">

  <!-- Load my combined JavaScript -->
  <script src="/resources/all.min.js" async></script>

  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <link rel="alternate" type="application/rss+xml" title="RSS feed for Primary Unit" href="/rss">
  <link rel="alternate" type="application/json" title="JSON feed for Primary Unit" href="/feed.json">

  <!-- Apple pinned sites icon, Apple touch icon, Favicon -->
  <link rel="mask-icon" href="/resources/favicon.svg" color="#1369BF">
  <link rel="apple-touch-icon-precomposed" href="/resources/favicon.png">
  <link rel="icon" href="/resources/favicon.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A mirror of https://www.robjwells.com hosted on GitHub">
</head>

<body>

<div class="wrapper">

<header class="site-header">

  <div class="site-title-container mute-links">
    <h1 class="site-title"><a href="https://robjwells.github.io">Primary Unit mirror on GitHub</a></h1>
    <p class="site-byline"><i>by</i> Rob Wells</p>
  </div>

  <div class="site-menu-container">

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/archives/">Archives</a></li>
        <li><a href="/feed.json">JSON&nbsp;feed</a></li>
        <li><a href="/rss">RSS&nbsp;feed</a></li>
      </ul>
    </nav>

    <label for="search-field" class="site-search-label">
      Site search
    </label>
    <form id="site-search" class="site-search" method="get" action="https://duckduckgo.com/">
      <input name="q" type="text" id="search-field" class="search-field" placeholder="via DuckDuckGo">
      <input name="sites" value="https://robjwells.github.io" hidden>
      <button type="submit" class="search-button">Search</button>
    </form>

  </div> <!-- .site-menu-container -->

</header> <!-- .site-header -->

<main role="main">

  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2014/01/hijacking-the-bbc/">Hijacking the BBC</a></h2>
      <p><time datetime="2014-01-08T15:56">Wednesday, January 8 2014</time></p>
    </header>
    <p>In December I started using <a href="http://rogueamoeba.com/audiohijackpro/">Audio Hijack Pro</a> to record <a href="http://www.bbc.co.uk/programmes/b006tt0y">Jazz on 3</a>, initially from the <a href="http://www.bbc.co.uk/radio/player/bbc_radio_three">Radio 3 live stream</a>. I soon realised this wasn’t a great idea: live streaming, Flash and an occasionally patchy internet connection don’t make for reliable recording.</p>
<p>A bit of searching turned up <a href="http://www.leancrew.com/all-this/2009/07/bbc-radio-2-and-audio-hijack-pro-scripts/">a blog post</a> and <a href="https://github.com/drdrang/radio2">GitHub repository</a> by Dr Drang — who else! His approach was to record programmes from the BBC website after they’ve been broadcast. This is more reliable, allows for repeated tries if the recording fails for any reason, and makes it easier to handle longer-than-usual episodes.</p>
<p>The logic is straightforward: find the unique ID for the programme’s most recent episode, use that to construct the player URL, and feed that to Audio Hijack.</p>
<p>Most of the work is done in Python, with Audio Hijack running bridging AppleScripts when a recording starts and finishes — the latter used by Dr Drang to add a track list to the recording’s lyrics field and add the file to iTunes.</p>
<p>This sounded ideal, but I couldn’t use the Doc’s work straight away as the scripts focus on Radio 2, use a player URL that doesn’t work (at least at home in Blighty) and need a few tweaks to fit my Python environment. It gave me an excuse to tinker with the wheel, if not <a href="http://www.leancrew.com/all-this/2014/01/reinventing-the-wheel/">reinvent it</a>.</p>
<p>If you want to follow along at home, all the code is <a href="https://bitbucket.org/robjwells/beeb-hijack/src/">in a Bitbucket repository</a>.</p>
<p>Before we dig in, there are two practical things to note:</p>
<ul>
<li>It’s all written for Python 3, but it wouldn’t take much to work on 2.</li>
<li>You’ll need to install <a href="http://www.crummy.com/software/BeautifulSoup/">Beautiful Soup 4</a> and <a href="http://docopt.org">docopt</a>.
    (Use <a href="http://www.pip-installer.org/en/latest/">pip</a>.)</li>
</ul>
<p>I initially wanted to consolidate the Python scripts into one file but that turned out to be stupid, so I (eventually) settled on having a module similar to Dr Drang’s that did most of the work and another script that acted as the command-line interface.</p>
<p>(That partly explains why <a href="https://bitbucket.org/robjwells/beeb-hijack/src/">my repo</a> has fewer files — the other being that I add the artwork in Audio Hijack’s tags tab, not a script.)</p>
<h3>Python module: bbcradio</h3>
<p>A look at the programme info dictionaries at the top of our modules reveals the differences in our methods:</p>
<div class="syntax"><pre><span></span><span class="c1"># Dr Drang’s</span>
<span class="n">showinfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;70s&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Sounds of the &#39;?70s&quot;</span><span class="p">)),</span>
            <span class="s1">&#39;60s&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Sounds of the &#39;?60s&quot;</span><span class="p">)),</span>
            <span class="s1">&#39;soul&#39;</span><span class="p">:(</span><span class="mi">2</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Trevor Nelson&quot;</span><span class="p">)),</span>
            <span class="s1">&#39;at&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;At the BBC&quot;</span><span class="p">))}</span>
<span class="c1"># Mine:</span>
<span class="n">PROG_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jazz on 3&#39;</span><span class="p">:</span> <span class="s1">&#39;b006tt0y&#39;</span><span class="p">,</span>
             <span class="s1">&#39;jazz line-up&#39;</span><span class="p">:</span> <span class="s1">&#39;b006tnmw&#39;</span><span class="p">}</span>
</pre></div>


<p>Each entry in the Doc’s dictionary is a tuple of the weekday as an integer — used to construct a URL for a daily schedule — and a regular expression to pick out the programme from the scraped schedule.</p>
<p>In mine I go after the programmes directly, as they all have a unique ID similar to the ones given to individual episodes. With this ID we can go to <a href="http://www.bbc.co.uk/programmes/b006tt0y/episodes/player">a list of the programme’s available episodes</a> and pluck out the most recent one.</p>
<p>This has two benefits: we don’t need to care about the broadcast day and don’t have to search the schedule page. All you need is the programme ID, which you can grab from the end of <a href="http://www.bbc.co.uk/programmes/b006tt0y">a programme’s home page</a> URL.</p>
<p>All the work is done in <code>latest_episode_code</code> in lines <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/bbcradio.py?at=default#cl-17">17–29</a>, which fetches the available episodes page and pulls the episode code for the first episode listed.</p>
<p>For weekly programmes only one episode is listed, but this technique also works for programmes which are broadcast more often — like <a href="http://www.bbc.co.uk/programmes/b006qj9z">Today</a>, which Dr Drang has <a href="http://www.leancrew.com/all-this/2009/10/adapting-bbc-radio-recording-scripts/">addressed specifically</a>. In such cases just make sure to record an episode while it’s the most recent on the available episodes page.</p>
<p>I’ve kept Dr Drang’s <a href="https://github.com/drdrang/radio2/blob/master/radio2.py#L37">episodeInfo</a> function — used to fetch the episode title, date and track list — <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/bbcradio.py?at=default#cl-38">largely intact</a>. I’ve added the time a track was played (if available — it’s often not) and I use a simpler method to fetch the broadcast date (pulling an <a href="http://tools.ietf.org/html/rfc3339#section-5.8">RFC 3339 date</a> from an attribute).</p>
<p>But there is one important difference: the use of Beautiful Soup’s <code>select</code> function, which allows for a liberal search for multiple class names, instead of <code>find_all</code>, which only returns elements which <em>exactly</em> match a given class string. This is important because every other track listing has an <code>alt</code> class.</p>
<h3>Command-line interface: beebhijack</h3>
<p>By itself bbcradio is inert, with the moving parts contained in <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/beebhijack?at=default">a single interface script</a> that has two modes which return an episode’s streaming URL or its details and track list. (Originally these were separate scripts, but there was a lot of duplicate code.)</p>
<p>At the command line you just pick a mode and supply a programme name. Here’s the help message:</p>
<pre><code>$ beebhijack -h
Usage:
    beebhijack url &lt;programme&gt;
    beebhijack details [--clean] &lt;programme&gt;

Options:
    --clean     Use two newlines instead of a pipe
                to separate the episode details

Accepted programmes:
    jazz on 3
    jazz line-up</code></pre>


<p>And, because I’m still blown away how simple <a href="http://docopt.org">docopt</a> is, here’s all the code needed to produce that interface:</p>
<div class="syntax"><pre><span></span><span class="lineno"> 7 </span><span class="n">programmes</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="lineno"> 8 </span><span class="s1">Accepted programmes:</span>
<span class="lineno"> 9 </span><span class="s1">    </span><span class="si">{}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bbcradio</span><span class="o">.</span><span class="n">PROG_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="lineno">12 </span><span class="s1">Usage:</span>
<span class="lineno">13 </span><span class="s1">    </span><span class="si">{name}</span><span class="s1"> url &lt;programme&gt;</span>
<span class="lineno">14 </span><span class="s1">    </span><span class="si">{name}</span><span class="s1"> details [--clean] &lt;programme&gt;</span>
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="s1">Options:</span>
<span class="lineno">17 </span><span class="s1">    --clean     Use two newlines instead of a pipe</span>
<span class="lineno">18 </span><span class="s1">                to separate the episode details</span>
<span class="lineno">19 </span>
<span class="lineno">20 </span><span class="si">{prog_list}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;beebhijack&#39;</span><span class="p">,</span> <span class="n">prog_list</span><span class="o">=</span><span class="n">programmes</span><span class="p">)</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span><span class="n">args</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
</pre></div>


<p>If you haven’t used it before, take 20 minutes to watch the <a href="http://docopt.org">docopt video</a>. It’s wonderful: give it a usage message and it hands you back a dictionary. Mine above is a little complicated because it tacks the list of accepted programmes onto the end of the usage message, in case you need a reminder at the command line. (I also print the list if you ask for a programme that’s not in the dictionary, in lines <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/beebhijack#cl-24">24–27</a>).</p>
<p>In the dictionary docopt returns, commands (url, details) get a boolean value, so the mode switch is a simple if-else if.</p>
<p>Unless given the <code>--clean</code> argument, the details mode prints the three parts of the tuple it gets from <code>episode_details</code> separated by pipes, which you can split up in AppleScript by changing the text item delimiters.</p>
<p>It’s important to note that I don’t exactly <code>print</code> the details — instead I encode the string into UTF-8 and <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/beebhijack#cl-38">write it as bytes</a> to <code>sys.stdout.buffer</code>. (<a href="https://github.com/drdrang/radio2/blob/master/radio2-tracklist#L44">Dr Drang’s script does something similar</a>.) The shell invoked by AppleScript’s <code>do shell script</code> command defaults to <a href="/2013/09/get-your-us-ascii-out-of-my-face/"><code>US-ASCII</code></a>, causing a UnicodeEncodeError if you try to <code>print</code> a string containing non-Ascii characters.</p>
<p>Generally, I think the key distinction between beebhijack and Dr Drang’s four scripts is that I keep all of the “real work” in the module.</p>
<p>For example, we both fetch the episode ID in our modules, but I also construct the streaming URL there (lines <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/bbcradio.py#cl-32">32–35</a>) while the Doc does that in <a href="https://github.com/drdrang/radio2/blob/master/radio2-stream">a separate script</a>.</p>
<p>This isn’t a big deal either way but I think it reveals my thinking about the beebhijack script: it’s a bridge between what you want to achieve and the program that actually does the work. The heaviest lifting done by beebhijack (joining the details) controls how the information is output, not what the information is.</p>
<h3>Putting it all together</h3>
<p>With the Python code sorted, all that’s left to do is to create individual pre- and post-recording AppleScripts that you get Audio Hijack to run (on the input and recording tabs, respectively).</p>
<p>The <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/Jazz%20Line-Up%20URL.applescript">pre-recording script</a> just calls beebhijack’s url mode and pass a programme name. I’ve copied Dr Drang’s, but separated out the programme name and path to the script into properties to make them easier to spot and change.</p>
<p>The same applies to <a href="https://bitbucket.org/robjwells/beeb-hijack/src/06686071d912f817b898b3c21bb88f3dc2d30ae6/Process%20Jazz%20Line-Up.applescript">the post-recording script</a>, which I stole off the Doc, who adapted one by Rogue Amoeba.</p>
<p>The biggest change I made was to use text-item delimiters to split up the episode date, title and track list as I don’t just put them all into the lyrics field, instead using the title and date to rename the track. (The date is necessary because, although I have Audio Hijack name the files with the date, the recording takes place at least the day after the broadcast day.)</p>
<p>I also don’t use a try block to handle errors fetching the episode details, because I prefer have an error message in the morning to prompt me to sort out the recording by hand.</p>
<p>Once you’ve got the scripts in place, just set an appropriate schedule in Audio Hijack. I have it set to record for much longer than the usual episode length, just in case a longer episode airs that I don’t expect. This doesn’t inflate the file size, because Audio Hijack doesn’t add silence when nothing is output from your source.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2013/11/die-bookmarks-bar-die/">Die, bookmarks bar, die</a></h2>
      <p><time datetime="2013-11-18T13:15">Monday, November 18 2013</time></p>
    </header>
    <p>I hate the bookmarks bar. This thing:</p>
<p class="pic no-squish">
    <img src="/images/2013-11-18_bookmarksbar.png" alt="The bookmarks bar in Safari" class="no-border">
</p>

<p>It’s all about the mouse here. Keyboard access is through <code>⌘1</code> for the first entry and so on, which often leaves me counting along to find which number I need.</p>
<blockquote>
<p>What’s the number for Pinboard: Unread? One… two… three… four!</p>
</blockquote>
<p>That’s gross and slow. It’s exactly the same reason why I use InDesign’s <a href="http://help.adobe.com/en_US/indesign/cs/using/WSa285fff53dea4f8617383751001ea8cb3f-6e68a.html#WSE4179F8F-7053-48b4-BFDC-2102D5F27789">quick apply panel</a> at work and don’t even try to remember the per-style keyboard shortcuts (which, handily, only work with the number pad).</p>
<p>It also applies to keyboard shortcuts more generally — if you don’t use them often enough you’ll forget what the shortcut is, annoying you later and often taking more time that it would to grab the mouse.</p>
<p>Assigning less-arbitrary shortcuts can be helpful, but again only if you use them fairly regularly.</p>
<p>Back to that horrid bookmark bar, though. How do we construct a <a href="http://www.obdev.at/products/launchbar/index.html">Launchbar</a>-style, search-based panel to get at those bookmarks? We’ll use Launchbar itself. (I guess you can do this in Quicksilver or Alfred, but I haven’t tried.)</p>
<p>Safari’s AppleScript support is fairly poor — it doesn’t expose your bookmarks to scripts. But it does have a handy <code>do JavaScript</code> command, which is all that those bookmarklets do: run JavaScript.</p>
<p>Grab the code (stored as the bookmark’s address) and — importantly — <a href="http://meyerweb.com/eric/tools/dencoder/">decode</a> it to turn entities such as <code>%7B</code> into <code>{</code>. Lop off the leading <code>javascript:</code> and insert it into this tiny AppleScript:</p>
<div class="syntax"><pre><span></span><span class="k">tell</span> <span class="nb">application</span> <span class="s2">&quot;Safari&quot;</span>
  <span class="k">set</span> <span class="nv">bookmarklet</span> <span class="k">to</span> <span class="s2">&quot;your_bookmarklet_code_here&quot;</span>
  <span class="k">set</span> <span class="nv">current_tab</span> <span class="k">to</span> <span class="nb">the</span> <span class="nv">current</span> <span class="no">tab</span> <span class="k">of</span> <span class="nb">the</span> <span class="nb">front</span> <span class="na">window</span>
  <span class="nv">do</span> <span class="nv">JavaScript</span> <span class="nv">bookmarklet</span> <span class="k">in</span> <span class="nv">current_tab</span>
<span class="k">end</span> <span class="k">tell</span>
</pre></div>


<p>Save that script into a new folder — mine’s in <code>~/Library/Scripts/Applications/Safari/Bookmarklets/</code></p>
<p>Lastly <a href="/images/2013-11-18_launchbarindex.png">add that new folder to Launchbar’s index</a>. I have my entry set to access on sub-search only, so to get to the bookmarklet scripts I type <code>bookm →</code> and I end up with this panel:</p>
<p class="full-width">
    <img src="/images/2013-11-18_launchbarpanel.png" alt="Launchbar’s list of my Safari bookmarklet scripts" class="no-border">
</p>

<p>And we’re set: a quick, searchable, keyboard-friendly list. If, like me, you <em>only</em> use the bookmarks bar for JavaScript bookmarklets you can go ahead and hide it as an added bonus.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2013/10/date-suffixes-in-python/">Date suffixes in Python</a></h2>
      <p><time datetime="2013-10-07T22:51">Monday, October 7 2013</time></p>
    </header>
    <p>A little while ago I wrote about <a href="/2013/03/setting-a-date-with-textexpander/">using TextExpander to write dates</a>, the bulk of which was given over to an Applescript that returned a long date complete with date suffixes.</p>
<p>Since I’ve been writing more and more Python, I thought it would be fun to rewrite it to see the difference between the two.</p>
<p>First, here’s my original Applescript:</p>
<div class="syntax"><pre><span></span><span class="lineno"> 1 </span><span class="k">set</span> <span class="nv">theDate</span> <span class="k">to</span> <span class="nb">the</span> <span class="nb">day</span> <span class="k">of</span> <span class="nb">the</span> <span class="p">(</span><span class="nb">current date</span><span class="p">)</span>
<span class="lineno"> 2 </span><span class="k">set</span> <span class="nv">theDay</span> <span class="k">to</span> <span class="nb">the</span> <span class="nv">weekday</span> <span class="k">of</span> <span class="nb">the</span> <span class="p">(</span><span class="nb">current date</span><span class="p">)</span>
<span class="lineno"> 3 </span><span class="k">set</span> <span class="nv">theMonth</span> <span class="k">to</span> <span class="nb">the</span> <span class="nb">month</span> <span class="k">of</span> <span class="nb">the</span> <span class="p">(</span><span class="nb">current date</span><span class="p">)</span>
<span class="lineno"> 4 </span><span class="k">set</span> <span class="nv">theYear</span> <span class="k">to</span> <span class="nb">the</span> <span class="nb">year</span> <span class="k">of</span> <span class="nb">the</span> <span class="p">(</span><span class="nb">current date</span><span class="p">)</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="k">set</span> <span class="nv">lastChar</span> <span class="k">to</span> <span class="p">(</span><span class="nb">the</span> <span class="nb">last</span> <span class="nb">character</span> <span class="k">of</span> <span class="p">(</span><span class="nv">theDate</span> <span class="k">as </span><span class="nc">string</span><span class="p">))</span> <span class="k">as</span> <span class="nv">number</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="k">if</span> <span class="nv">lastChar</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nv">lastChar</span> <span class="ow">is</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nv">theDate</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="nv">theDate</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="k">then</span>
<span class="lineno"> 9 </span>  <span class="k">set</span> <span class="nv">theDate</span> <span class="k">to</span> <span class="p">(</span><span class="nv">theDate</span> <span class="k">as </span><span class="nc">string</span><span class="p">)</span> <span class="o">&amp;</span> <span class="s2">&quot;th&quot;</span>
<span class="lineno">10 </span><span class="k">else</span>
<span class="lineno">11 </span>  <span class="k">set</span> <span class="nv">theSuffixes</span> <span class="k">to</span> <span class="p">{</span><span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;nd&quot;</span><span class="p">,</span> <span class="s2">&quot;rd&quot;</span><span class="p">}</span>
<span class="lineno">12 </span>  <span class="k">set</span> <span class="nv">theDate</span> <span class="k">to</span> <span class="p">(</span><span class="nv">theDate</span> <span class="k">as </span><span class="nc">string</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">item</span> <span class="nv">lastChar</span> <span class="k">of</span> <span class="nv">theSuffixes</span><span class="p">)</span>
<span class="lineno">13 </span><span class="k">end</span> <span class="k">if</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span><span class="no">return</span> <span class="p">(</span><span class="nv">theDay</span> <span class="o">&amp;</span> <span class="s2">&quot;, &quot;</span> <span class="o">&amp;</span> <span class="nv">theMonth</span> <span class="o">&amp;</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;</span> <span class="nv">theDate</span> <span class="o">&amp;</span> <span class="s2">&quot;, &quot;</span> <span class="o">&amp;</span> <span class="nv">theYear</span><span class="p">)</span> <span class="k">as </span><span class="nc">string</span>
</pre></div>


<p>And now the Python:</p>
<div class="syntax"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/usr/local/bin/python3</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="lineno"> 6 </span><span class="n">date_string</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%A, %B #, %Y&#39;</span><span class="p">)</span>
<span class="lineno"> 7 </span><span class="n">day</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">day</span>
<span class="lineno"> 8 </span>
<span class="lineno"> 9 </span><span class="k">if</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;</span> <span class="n">day</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">23</span> <span class="o">&lt;</span> <span class="n">day</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">):</span>
<span class="lineno">10 </span>  <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;th&#39;</span>
<span class="lineno">11 </span><span class="k">else</span><span class="p">:</span>
<span class="lineno">12 </span>  <span class="n">suffixes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;st&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;nd&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;rd&#39;</span><span class="p">}</span>
<span class="lineno">13 </span>  <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffixes</span><span class="p">[</span><span class="n">day</span> <span class="o">%</span> <span class="mi">10</span><span class="p">]</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span><span class="nb">print</span><span class="p">(</span><span class="n">date_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">day</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>


<div class="flag">
    <p>
        <strong>Update: <time>2015-01-17</time></strong>
    </p>
    <p>
        <a href="/2015/01/updated-date-suffix-script/">I’ve improved the Python code.</a> Please use the more recent code and not that above.
    </p>
</div>

<p>A date object, kind of similar to Applescript’s <code>current date</code>, is constructed on line 5. This is used to build a formatted date on line 6, which is complete bar the day of the month. I swap it out for a # placeholder because both <code>strftime</code> options for the day fall short: <code>%d</code> is padded with a zero, and <code>%e</code> is padded with a space. So instead I pull out the day separately in line 7.</p>
<p>The date-testing logic on line 9 is simpler and more explicit in this version, testing first for any date that takes a -th. Those dates that require a different suffix get dumped to the else clause.</p>
<p>A bit of modulo arithmetic on line 13 reduces the date integer to the units digit, which is used to key into a dictionary holding the suffixes.</p>
<p>The day and its suffix are concatenated, and are inserted into the formatted date on line 15 using the <code>replace</code> string method (god I love Python’s string methods) and printed, with <code>end=''</code> suppressing the standard newline.</p>
<p>Though the line count is the same between the two, the Python version has about half the characters of the Applescript. I think the Applescript’s verbosity — which I don’t help with that conditional — makes it harder to understand at a glance, while the Python is very clear, excepting the <code>strftime</code> format string.</p>
<p>As a side note, I don’t actually use either of these scripts for my long date, having given in to “Weekday month day year” without a suffix or any commas. This can be constructed using TextExpander’s own date macros, which mirror <code>strftime</code> formatting: <code>%A %B %e %Y</code>. Still, a fun exercise.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2013/09/quit-to-linux/">Quit to Linux</a></h2>
      <p><time datetime="2013-09-17T23:16">Tuesday, September 17 2013</time></p>
    </header>
    <p>Usually I dislike commenting on stuff in the news, instead keeping to topics I have at least some direct experience of — even if I’m frequently documenting my own lack of experience.</p>
<p>But I believe that a lot of people are misinterpreting <a href="http://arstechnica.com/gaming/2013/09/gabe-newell-linux-is-the-future-of-gaming-new-hardware-coming-soon/">Gabe Newell’s keynote speech at LinuxCon</a>, in which he said that Linux is the “future of gaming”. In just over a day that Ars article has drawn over 400 comments but only a handful have come close to what I believe is the real issue.</p>
<p>(If you’ve only read summaries, I urge you to <a href="https://www.youtube.com/watch?v=Gzn6E2m3otg">watch Gabe’s talk</a>. It’s only about 20 minutes long.)</p>
<p>Most of the reaction concerns Windows 8, its software store and tightly-controlled computing environments in general. This misses the point.</p>
<p>Here’s my take: Valve are preparing for the next decade of PC gaming.</p>
<p>But first let’s do a bit of groundwork that will address the common arguments against Gabe’s talk (or what those people imagine he said) and put us in position to view the wider landscape.</p>
<p>Valve began considering the direction of the PC industry “several years ago”. When Gabe talks about “some bad thinking” it’s clear that he means iOS and the tightly-controlled App Store. It should be obvious that Steam would not have been able to exist in that environment.</p>
<p>Steam started on Windows. So where’s Windows now? Doing OK. Windows 8 is a tad confused but doing fine. The Windows Store that plenty of commenters think that Valve fears will eat its lunch? A bit like the Mac App Store. Nothing to worry about.</p>
<p>But where is Windows going? To answer that you must consider where Microsoft is going.</p>
<p><em>No-one knows where Microsoft is going.</em> I don’t think that Microsoft even knows where Microsoft is going.</p>
<p>Its 13-year CEO <a href="http://www.microsoft.com/en-us/news/press/2013/aug13/08-23statementpr.aspx">has just been fired</a> and it desperately needs to unhook itself from the twin Windows and Office morphine drips. Selling Windows licences to PC-makers hits a snag when <a href="http://arstechnica.com/business/2013/07/five-consecutive-quarters-of-sliding-pc-sales-mark-a-new-industry-record/">PC unit sales fall off a cliff</a> and it’s difficult to sell Office to people on <a href="http://www.asymco.com/2013/06/03/forecasting-windows-market-share/">platforms where they can’t buy it</a> even if they wanted to.</p>
<p>If Microsoft is going to survive it needs to get out of that business, though it may be a case of <a href="https://en.wikipedia.org/wiki/Bến_Tre#Vietnam_War">having to destroy the village in order to save it</a>. (<a href="http://atp.fm/episodes/28-the-pit-of-irrelevance">Hat-tip</a>.)</p>
<p>So where does that leave Windows? It’s not clear but the mishmash of tablet and desktop OS that is Windows 8, coupled with the Windows Store, suggests Microsoft wants to head in Apple’s direction. It is this which I think Gabe was referring to when <a href="http://arstechnica.com/gaming/2012/07/steams-newell-windows-8-catastrophe-driving-valve-to-embrace-linux/">he branded Windows 8 a “catastrophe”</a>.</p>
<p>The end of Windows as we know it? <em>Impossible!</em> Well maybe not. Microsoft’s in a bind and who knows what it is willing to throw into the engine in order to keep the wheels turning?</p>
<p>Valve makes <a href="http://www.forbes.com/sites/oliverchiang/2011/02/15/valve-and-steam-worth-billions/">a lot of money from Steam</a> but it’s dependent on having a stable environment where it can more or less do what it likes, ship whatever client software it wants with a store run in a way that suits the business and its customers. Not the rules of a third party.</p>
<p>Linux provides that platform. It is stable in the sense that it has no master which can suddenly make a self-interested change that makes life difficult for Valve.</p>
<p>This is not about the quality of Windows 8, how much business the Windows Store is going to take from Steam or an objection to giving a controlling party some say or a monetary cut.</p>
<p>This is about moving to a platform in which Steam can exist without a guillotine blade hanging over its head.</p>
<p>However, Valve can’t just snap its fingers and have everyone switch to Linux (as many, many commenters noted). But let me tell you a story.</p>
<p>My Steam account is 10 years old this month. I signed up in September 2003. At the time Steam was a joke. There was a <a href="/images/2013-09-17_steam.gif">horrendous GIF</a> doing the rounds that unfortunately summed up the feelings of a lot of users. Steam was rubbish. About the only thing you could do was play Counter-Strike 1.6.</p>
<p>When Valve announced that you would be able to download Half-Life 2 instead of buying a physical copy I wondered why anyone would want to spend several days downloading a game when you could just nip to the shops.</p>
<p>A decade later I have <a href="http://steamcommunity.com/id/robjwells/games?tab=all">about 200 games registered on my Steam account</a> and I haven’t bought a disc copy of a game in two years (and that was <a href="http://www.deusex.com/augmented">an exceptional case</a>).</p>
<p>The Linux user experience can often suck. Few ordinary gamers use it and few developers release games for it. But these are solvable problems.</p>
<p>Valve’s plan for Linux is not for now, it’s for the future. But it starts now.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2013/09/get-your-us-ascii-out-of-my-face/">Get your US-ASCII out of my face</a></h2>
      <p><time datetime="2013-09-14T14:05">Saturday, September 14 2013</time></p>
    </header>
    <div class="flag">
  <p><strong>Warning: The contents of this post may not be up to date!</strong></p>
  <p>Sorry, but if you’re searching for answers about why you can’t reliably set environment variables in OS X (particularly <code>PATH</code>), the information below may be out of date.</p>
  <p>Apple has changed the system so many times in so many different ways it’s difficult to find <em>anything</em> on the internet about this that is correct and up-to-date, so I’ve placed this warning on the top of every post I’ve written about it.</p>
  <p>As of 2017-03-02 it appears that the best collection of information is <a href="https://github.com/ersiner/osx-env-sync">the osx-env-sync project on GitHub</a> and its associated issues.</p>
  <p>Be wary of anything that you find on StackOverflow: the answers there may well have been correct at the time but incorrect now.</p>
  <p>For reference, my own posts on this problem (newest first) are:</p>
  <ul>
    <li><a href="/2017/03/setting-os-xs-environment/">Setting OS X’s environment</a></li>
    <li><a href="/2014/12/locale-in-os-x-whats-the-current-situation/">Locale in OS X — what’s the current situation?</a></li>
    <li><a href="/2014/12/locale-in-os-x-and-launch-agents/">Locale in OS X and Launch Agents</a></li>
    <li><a href="/2013/09/get-your-us-ascii-out-of-my-face/">Get your US-ASCII out of my face</a></li>
  </ul>
</div>

<p>When I was writing the script in <a href="/2013/09/solo-diff/">yesterday’s post</a> I came across this bizarre text encoding problem:</p>
<pre><code>UnicodeDecodeError: 'ascii' codec can't decode byte
0xe2 in position 5: ordinal not in range(128)</code></pre>


<p>Ascii what? We’re all Unicode now, don’t you know? If I’m taking in UTF-8 text, keeping it in a Unicode string, and then writing it out to UTF-8 encoded text files where is goddamn Ascii creeping in?</p>
<p>This first occurred at work, while I was <em>trying to work</em>, so my horrendous hack solution was to switch the temporary files into binary mode and encode the two strings into UTF-8 before writing them out. (This was when the script was still a text filter, so the problem was only on the back end.)</p>
<p>That’s a horrible hack. Bytes! Yuck! So in my next attempt I explicitly opened the files with a UTF-8 encoding. Which was still gross. And totally unnecessary. This is Python 3, everything’s Unicode, all the defaults are UTF-8, why am I having to specify the encoding at every point?</p>
<p>This was the point at which I found <a href="http://stackoverflow.com/questions/5981570/encoding-errors-running-python-from-within-bbedit?rq=1">a relevant Stack Overflow question</a>. Unfortunately the answer there was to tinker with Python’s start-up files in a way that was always discouraged and had since been removed from Python 3.</p>
<p>Hm. But what’s this about <code>sys.setdefaultencoding</code>? So I started poking around with this terrible little script:</p>
<div class="syntax"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="n">entire_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;BB_DOC_PATH&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">entire_file</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">())</span>
</pre></div>


<p>For the last three lines, which print the encodings used, I got:</p>
<pre><code>US-ASCII    # File encoding
utf-8       # sys.getdefaultencoding
US-ASCII    # locale.getpreferredencoding</code></pre>


<p>So the system setting wasn’t the culprit. But why is the system encoding different to the locale, which seems to determine the default encoding with which files are opened?</p>
<p>Locale refers to the environment variables in my Terminal, but when I try <code>echo $LANG</code> it’s set to <code>en_GB.UTF-8</code> — surely that’s not the problem?</p>
<h3>WRONG.</h3>
<p>As <a href="http://www.velocityreviews.com/forums/t695885-print-and-unicode-strings-python-3-1-a.html">this thread</a> eventually made me realise, I didn’t actually have <code>$LANG</code> set to anything — it was all smoke and mirrors that cleared away when I ran the script through BBEdit. (I also had a similar problem with Applescript’s <code>do shell script</code> and it looks like <a href="http://www.sublimetext.com/forum/viewtopic.php?t=13753">Sublime Text users</a> have also run into it.) Checking the <code>os.environ</code> output from the script above confirmed it: no <code>$LANG</code>.</p>
<p>The root of the problem is that if a locale isn’t set it defaults to the C locale — meaning US-ASCII in OS&nbsp;X. <strong>The solution is to explicitly set $LANG in your .bash_profile</strong>:</p>
<div class="syntax"><pre><span></span><span class="nb">export</span> <span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;en_GB.UTF-8&quot;</span>
</pre></div>


<p>I’ve also got that line in ~/.bashrc for safety, but do bear in mind that <em>some shells will ignore both</em> ~/.bash_profile and ~/.bashrc.</p>
<p>You could set the other <code>LC_*</code> keywords as well, if you like, but <code>$LANG</code> should be enough according to <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/locale.1.html">the man page for <code>locale</code></a>:</p>
<pre><code>LANG         Used as a substitute for any unset LC_* variable.  If LANG
             is unset, it will act as if set to &quot;C&quot;.  If any of LANG or
             LC_* are set to invalid values, locale acts as if they are
             all unset.</code></pre>


<div class="flag">
  <p><strong>Update 2013-09-21</strong></p>
  <p>I’ve just re-watched <a href="http://nedbatchelder.com/text/unipain.html">Ned Batchelder’s great Pragmatic Unicode video</a> and while setting the <code>$LANG</code> environment variable is a handy solution on your own machines, it’s not a good fit when you’re writing a program that will run on systems where you can’t control the default encoding.</p>
  <p>In such cases it makes sense to adopt his “Unicode sandwich” approach of explicitly decoding I/O and then working on the resulting Unicode.</p>
</div>
  </article>
  <div class="pagination">
<p class="pagination-older"><a href="https://robjwells.github.io/page-17/">Older posts</a></p><p class="pagination-newer"><a href="https://robjwells.github.io/page-15/">Newer posts</a></p>  </div>

</main>

<footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> <!-- .site-footer -->

</div> <!-- .wrapper -->

</body>

</html>