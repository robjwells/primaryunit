<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Primary Unit mirror on GitHub – page 4</title>

  <!-- Load my combined stylesheet -->
  <link rel="stylesheet" href="/resources/all.min.css">

  <!-- Load my combined JavaScript -->
  <script src="/resources/all.min.js" async></script>

  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <link rel="alternate" type="application/rss+xml" title="RSS feed for Primary Unit" href="/rss">
  <link rel="alternate" type="application/json" title="JSON feed for Primary Unit" href="/feed.json">

  <!-- Apple pinned sites icon, Apple touch icon, Favicon -->
  <link rel="mask-icon" href="/resources/favicon.svg" color="#1369BF">
  <link rel="apple-touch-icon-precomposed" href="/resources/favicon.png">
  <link rel="icon" href="/resources/favicon.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A mirror of https://www.robjwells.com hosted on GitHub">
</head>

<body>

<div class="wrapper">

<header class="site-header">

  <div class="site-title-container mute-links">
    <h1 class="site-title"><a href="https://robjwells.github.io">Primary Unit mirror on GitHub</a></h1>
    <p class="site-byline"><i>by</i> Rob Wells</p>
  </div>

  <div class="site-menu-container">

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/archives/">Archives</a></li>
        <li><a href="/feed.json">JSON&nbsp;feed</a></li>
        <li><a href="/rss">RSS&nbsp;feed</a></li>
      </ul>
    </nav>

    <label for="search-field" class="site-search-label">
      Site search
    </label>
    <form id="site-search" class="site-search" method="get" action="https://duckduckgo.com/">
      <input name="q" type="text" id="search-field" class="search-field" placeholder="via DuckDuckGo">
      <input name="sites" value="https://robjwells.github.io" hidden>
      <button type="submit" class="search-button">Search</button>
    </form>

  </div> <!-- .site-menu-container -->

</header> <!-- .site-header -->

<main role="main">

  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/05/json-feed/">JSON Feed</a></h2>
      <p><time datetime="2017-05-20T00:02">Saturday, May 20 2017</time></p>
    </header>
    <p>I added support for <a href="https://jsonfeed.org">JSON Feed</a> to my homemade static site generator <a href="https://github.com/robjwells/majestic">Majestic</a> today, and thought I’d note it because funnily enough the two implementations <a href="https://daringfireball.net/linked/2017/05/19/json-feed-jekyll">mentioned by John Gruber</a> (by <a href="https://github.com/hafniatimes/hafniatimes.github.io/blob/master/_layouts/jsonfeed.html">Niclas Darville</a> and <a href="https://github.com/jmacdotorg/plerd/blob/master/templates/jsonfeed.tt">Jason McIntosh</a>) used the approach I’d taken for <a href="https://github.com/robjwells/majestic/blob/master/majestic/default_templates/majestic-rss.xml">generating my RSS feed</a> and wanted to avoid.</p>
<p>Basically all three of those define a document template and pass in the posts and other required bits, and you’re done. I’m really not knocking this — again, I do this with the RSS feed and it validates fine. It’s all good.</p>
<p>But I ended up templating my RSS feed like this because I looked at the <a href="https://pypi.python.org/pypi/feedgenerator/1.9">feedgenerator</a> module and ran away. Majestic was my first Python project of any real size and I wanted to keep things as straightforward as I could. While it looks (with hindsight) <a href="https://github.com/getpelican/pelican/blob/master/pelican/writers.py">reasonably OK in use</a>, it doesn’t have any documentation, has been pulled out of Django, and has funky class names (<code>Rss201rev2Feed</code>) that didn’t fill me with confidence that I could implement an RSS feed quickly.</p>
<p>I was using <a href="http://jinja.pocoo.org">Jinja</a> templating for the site and since HTML and XML are cousins just did that. But you can probably tell that I didn’t really know what I’m doing (still don’t!) with escaping as any field that might contain non-Ascii characters is wrapped in <code>&lt;![CDATA[…]]&gt;</code> tags.</p>
<p>But hey, it works. Feed’s valid.</p>
<p>With JSON, everything just feels much more obvious. In Python you hand off basic types to the built-in <a href="https://docs.python.org/3/library/json.html">json</a> module and you get back a string, all the encoding taken care of. And if I make a mistake Python will complain at me, instead of just dumping out a file of questionable worth.</p>
<p>I think this is what all the people complaining on the Hacker News thread missed. Working in JSON is comfortable and familiar — the tools are good and you get told when something goes wrong. Working with XML can be unclear and a bit of a pain, and creating an invalid document is a risk.</p>
<p>So my super-duper advanced JSON Feed implementation is… constructing a <code>dict</code>, adding things to it and passing it off to the json module that I use <em>all the time</em>. Taken care of. The code’s so boring I’m not even going to include it here (but <a href="https://github.com/robjwells/majestic/blob/d88aabba2dc0059814955802408fb46dc452c0de/majestic/collections.py#L130">it’s online to view</a>).</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/centrism/">Centrism</a></h2>
      <p><time datetime="2017-04-24T00:05">Monday, April 24 2017</time></p>
    </header>
    <p>Diamond Geezer <a href="http://diamondgeezer.blogspot.co.uk/2017/04/left-right.html">asks</a>: “Why do we never end up in the middle?”</p>
<p>It’s unfair to pick on him, but I will because he posted on a day when my annoyance at centrist liberals has well and truly peaked.</p>
<p>First off, the “centre ground” is a concept that is entirely relative. When Jeremy Corbyn campaigned to become and was elected leader of the Labour Party in 2015, he managed to shift the centre ground — the Tories very quickly ditched a plan to bomb the Syrian government.</p>
<p>The centre ground is inherently unstable because it only exists relative to the two dominant forces either side. At our present moment that’s a fairly right-wing Conservative Party and a reasonably social democratic Labour Party. Any “centrist” must define themselves in opposition to their closest opponents on the left and right.</p>
<p>Ultimately if you do that it means you have no principles, nothing that anchors you on the left-right axis. In reality — as much as we joke about spineless politicians — few define their positions in this way and instead the “centre” in various countries is the home to a party that has “right-wing” economic policies and “left-wing” social policies. In Britain that would be the Liberal Democrats, despite Tim Farron’s recent attempts to win over the homophobes.</p>
<p>Left and right are in scare quotes above because this shows the point at which the left-right axis breaks down.</p>
<p>Ultimately the idea of centrism is bankrupt. Politics is a clash of interests. The ideas of the “centre ground,” of the “national interest,” are rubbish. Howard Zinn put it best in his People’s History of the United States:</p>
<blockquote>
<p>Nations are not communities and never have been. The history of any country, presented as the history of a family, conceals the fierce conflicts of interest (sometimes exploding, often repressed) between conquerors and conquered, masters and slaves, capitalists and workers, dominators and dominated in race and sex.</p>
</blockquote>
<p>As a socialist, to use our compromised axis, the boss class sits on the right and the workers on the left. Given that the boss class is but a tiny sliver of the population, what credibility does a “centrist” party have, one that pretends to balance the desires of the exploited and the exploiters?</p>
<p>It this this “refreshing centrism” that irks me the most, as it is always right-wing economic policies paired with some ameliorating factor — support for gay marriage, say — to assuage the liberals.</p>
<p>But if you’re gay, does being able to officially consecrate your relationship make up for the fact that you spend half your wages on rent?</p>
<p>This has run on, so let’s talk about Emmanuel Macron. <a href="https://www.theguardian.com/commentisfree/2017/apr/23/the-guardian-view-on-france-election-a-win-for-macron-and-hope">The Guardian loves him</a>, noting (without the expected contradicting clause) that it “is tempting … to conclude that European liberal values have successfully rallied to stop another lurch to the racist right.”</p>
<p>And so Macron, an explicit neoliberal, is raised up having defeated (we’ll see) the fascist Marine Le Pen.</p>
<p>The celebration is of liberal values, embodied by Macron. But Macron’s liberal values go a long way to explain the surge in support for France’s fascist National Front, as <a href="http://wpj.dukejournals.org/content/34/1/18.full">Cole Stangler shows</a>. His liberal values are likely to increase “<a href="https://www.dissentmagazine.org/online_articles/french-election-trouble-with-emmanuel-macron-centrism">unemployment, inequality and poverty</a>” through his right-wing economic policies — along the lines of the French law that bears his name (loi Macron) and hacked away at workers’ rights.</p>
<p>The assault on workers’ rights and public services has been ongoing for nearly 40 years yet liberals and centrists deride the term that describes our current phase: neoliberalism.</p>
<p>The refusal to recognise this trend puts us in a position where the Guardian celebrates the likely victory of Macron, cheering his defeat of the fascists in blissful ignorance. But his political current is the reason why we have ended up with the fascists contesting the second round of the French presidential election (<a href="https://en.wikipedia.org/wiki/French_presidential_election,_2002">again</a>).</p>
<p>Faced with falling employment and living standards for four decades and (generally) abandoned by the organised left, people have turned to those who promise to take action to improve their material conditions.</p>
<p>Yet Macron’s policies will just exacerbate these problems. This isn’t the end of the fascist challenge in France; should Macron win and pursue his neoliberal programme we could well be in the same situation in five years’ time.</p>
<p>(Unless, potentially, the French left organises a strong anti-fascist campaign like that waged in Britain from the 1970s to the present time, in which the fascists have more or less been suffocated.)</p>
<p>This isn’t a “bold break with the past,” it is the continuation of the rule of the boss class with a fresh coat of paint.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/indesign-pdf-metastasis/">InDesign PDF metastasis</a></h2>
      <p><time datetime="2017-04-17T22:25">Monday, April 17 2017</time></p>
    </header>
    <p>At work we deal a lot with PDFs, both press quality and low-quality for viewing on screen. Over time I’ve automated a fair amount of the creation for both types, but one thing that I haven’t yet done is automate file-size reductions for the low-quality PDFs.</p>
<p>(We still use InDesign CS4 at work, so bear in mind that some or all of the below may not apply to more recent versions.)</p>
<p>It’s interesting to look at exactly what is making the files large enough to require slimming down in the first place. All our low-quality PDFs are exported from InDesign with the built-in “Smallest file size” preset, but the sizes are usually around 700kB for single tabloid-sized, image-sparse pages.</p>
<p><img src="/images/2017-04-17-arts-full.jpg"
     class="pull-right"
     alt="A low-quality image of a Morning Star arts page."></p>
<p>Let’s take Tuesday’s arts page as our example. It’s pretty basic: two small images and a medium-sized one, two drop shadows, one transparency and a fair amount of text. (That line of undermatter in the lead article was corrected before we went to print.)</p>
<p>But exporting using InDesign’s lowest-quality PDF preset creates a 715kB file. The images are small and rendered at a low DPI, so they’re not inflating the file.</p>
<p>Thankfully you can have a poke around PDF files with your favourite text editor (<a href="http://www.barebones.com/products/bbedit/">BBEdit</a>, obviously). You’ll find a lot of “garbage” text, which I imagine is chunks of binary data, but there’s plenty of plain text you can read. The big chunks tend to be metadata. Here’s part of the first metadata block in the PDF file for the arts page:</p>
<div class="syntax"><pre><span></span><span class="nt">&lt;x:xmpmeta</span> <span class="na">xmlns:x=</span><span class="s">&quot;adobe:ns:meta/&quot;</span> <span class="na">x:xmptk=</span><span class="s">&quot;Adobe XMP […]&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;rdf:RDF</span> <span class="na">xmlns:rdf=</span><span class="s">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;rdf:Description</span> <span class="na">rdf:about=</span><span class="s">&quot;&quot;</span>
    <span class="na">xmlns:xmp=</span><span class="s">&quot;http://ns.adobe.com/xap/1.0/&quot;</span>
    <span class="na">xmlns:dc=</span><span class="s">&quot;http://purl.org/dc/elements/1.1/&quot;</span>
    <span class="na">xmlns:photoshop=</span><span class="s">&quot;http://ns.adobe.com/photoshop/1.0/&quot;</span>
    <span class="err">…</span> <span class="err">Blah</span> <span class="err">blah</span> <span class="err">blah</span> <span class="err">exif</span> <span class="err">data</span> <span class="err">etc</span> <span class="err">…</span>
  <span class="err">&lt;/rdf:Description</span><span class="nt">&gt;</span>
 <span class="nt">&lt;/rdf:RDF&gt;</span>
<span class="nt">&lt;/x:xmpmeta&gt;</span>
</pre></div>


<p>Which is the none-too-exciting block for one of the images, a Photoshop file. There’s two more like this, roughly 50–100 lines each. Then we hit a chunk which describes the InDesign file itself, with this giveaway line:</p>
<div class="syntax"><pre><span></span><span class="nt">&lt;xmp:CreatorTool&gt;</span>Adobe InDesign CS4 (6.0.6)<span class="nt">&lt;/xmp:CreatorTool&gt;</span>
</pre></div>


<p>So what, right? InDesign includes some document and image metadata when it exports a PDF. Sure, yeah. I mean, the metadata blocks for the images weren’t too long, and this is just about their container.</p>
<p>Except this InDesign metadata block is 53,895 lines long in a file that’s 86,585 lines long. 574,543 characters of the document’s 714,626 — 80% of the file.</p>
<p>I think it’s safe to say we’ve found our culprit. But what’s going on in those 54,000 lines? Well, mostly this:</p>
<div class="syntax"><pre><span></span><span class="nt">&lt;xmpMM:History&gt;</span>
   <span class="nt">&lt;rdf:Seq&gt;</span>
      <span class="nt">&lt;rdf:li</span> <span class="na">rdf:parseType=</span><span class="s">&quot;Resource&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;stEvt:action&gt;</span>created<span class="nt">&lt;/stEvt:action&gt;</span>
         <span class="nt">&lt;stEvt:instanceID&gt;</span>xmp.iid:[… hex ID …]<span class="nt">&lt;/stEvt:instanceID&gt;</span>
         <span class="nt">&lt;stEvt:when&gt;</span>2012-05-22T12:55:27+01:00<span class="nt">&lt;/stEvt:when&gt;</span>
         <span class="nt">&lt;stEvt:softwareAgent&gt;</span>Adobe InDesign 6.0<span class="nt">&lt;/stEvt:softwareAgent&gt;</span>
      <span class="nt">&lt;/rdf:li&gt;</span>
      <span class="nt">&lt;rdf:li</span> <span class="na">rdf:parseType=</span><span class="s">&quot;Resource&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;stEvt:action&gt;</span>saved<span class="nt">&lt;/stEvt:action&gt;</span>
         <span class="nt">&lt;stEvt:instanceID&gt;</span>xmp.iid:[… hex ID …]<span class="nt">&lt;/stEvt:instanceID&gt;</span>
         <span class="nt">&lt;stEvt:when&gt;</span>2012-05-22T12:55:54+01:00<span class="nt">&lt;/stEvt:when&gt;</span>
         <span class="nt">&lt;stEvt:softwareAgent&gt;</span>Adobe InDesign 6.0<span class="nt">&lt;/stEvt:softwareAgent&gt;</span>
         <span class="nt">&lt;stEvt:changed&gt;</span>/<span class="nt">&lt;/stEvt:changed&gt;</span>
      <span class="nt">&lt;/rdf:li&gt;</span>
    <span class="c">&lt;!--  1,287 more list items  --&gt;</span>
   <span class="nt">&lt;/rdf:Seq&gt;</span>
<span class="nt">&lt;/xmpMM:History&gt;</span>
</pre></div>


<p>It’s effectively a record of every time the document was saved. But if you look at the <code>stEvt:when</code> tag you’ll notice the first items are from 2012 — when our “master” InDesign file from which we derive our edition files was first created. So, the whole record of that master file is included in every InDesign file we use, and the PDFs we create from them.</p>
<p>Can we remove this metadata from InDesign? You can see it in <span class="osx-menu">File ▸ File Info… ▸ Advanced</span>, select it and press the rubbish bin icon. Save, quit, reopen and… it’s still there.</p>
<p>Thankfully Acrobat can remove this stuff from your final PDF, by going through the “PDF Optimizer” or “Save Optimized PDF” or whatever menu item it’s hiding under these days. (In the “Audit Space Usage” window it corresponds to the “Document Overhead”.)</p>
<p>Unfortunately Acrobat’s AppleScript support has always been poor — I’ve no idea what it’s like now, remember we’re talking CS4 — and I’ve no time nor desire to dive into Adobe’s JavaScript interface. So while you can (and we do) automate the PDF exports, you can’t slim these files down automatically with Acrobat.</p>
<p>Our solution at work has been to cut the cruft from the PDF using Acrobat when we use it to combine our separate page PDFs by hand. But ultimately I want to automate the whole process of exporting the PDFs, stitching them together in order, and reducing the file size.</p>
<p>After using <a href="https://ghostscript.com">ghostscript</a> for our <a href="https://github.com/ppps/ms-barcode">automatic barcode creation</a>, I twigged that it would be useful for processing the PDFs after creation, and sure enough you can use it to slim down PDFs. Here’s an example command:</p>
<pre><code>gs -sDEVICE=pdfwrite \
   -dPDFSETTINGS=/screen \
   -dCompatibilityLevel=1.5 \
   -dNOPAUSE -dQUIET -dBATCH \
   -sOutputFile=&quot;11_Books_180417-smaller.pdf&quot; \
   &quot;11_Books_180417.pdf&quot;</code></pre>


<p>Most of that is ghostscript boilerplate (it’s not exactly the friendliest tool to use), but the important option is <code>-dPDFSETTINGS=/screen</code> which, according to <a href="https://ghostscript.com/doc/9.14/Ps2pdf.htm#Options">one page of the sprawling docs</a>, is a predefined Adobe Distiller setting.</p>
<p>Using it on our 715kB example spits out an 123kB PDF that is visually identical apart from mangling the drop shadows (which I think can be solved by changing the transparency flattening settings when the PDF is exported from InDesign).</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/redundant-publishing/">Redundant publishing</a></h2>
      <p><time datetime="2017-04-16T22:39">Sunday, April 16 2017</time></p>
    </header>
    <p>In my previous post about <a href="/2017/04/page-speed/">page speed</a>, I mentioned that I’d written <a href="https://github.com/robjwells/majestic">my own site generator</a>. I’m not quite ready to talk specifically about it — I want to write some documentation first — and really I doubt that anyone but me <em>should</em> be using it.</p>
<p>But, having set up <a href="https://s3.robjwells.com">publishing to Amazon S3</a> today, I wanted to write up how I publish this blog to multiple places so that it’ll be around whatever (within reason) might happen.</p>
<p><a href="https://github.com/robjwells/majestic">Majestic</a>’s configuration files are set up in such a way that you have have a default settings file in a directory — <code>settings.json</code> — and you can specify others that make adjustments to that.</p>
<p>In my case the main settings file contains the configuration for publishing to my own server (hosted at Linode) — not the nitty gritty of how to get it on to the server, but what the URLs, site title, etc should be. (It’s online if you want to <a href="https://github.com/robjwells/primaryunit/blob/master/settings.json">have a nose around</a>.)</p>
<p>Then I have two extra JSON files: <code>robjwells.github.io.json</code> and <code>s3.robjwells.com.json</code>, which contain the customisations for publishing for those domains. Here’s the config for GitHub in full:</p>
<div class="syntax"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;site&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://robjwells.github.io&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Primary Unit mirror on GitHub&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A mirror of https://www.robjwells.com hosted on GitHub&quot;</span>
  <span class="p">},</span>

  <span class="nt">&quot;paths&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;output root&quot;</span><span class="p">:</span> <span class="s2">&quot;gh-pages&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Setting <code>site.url</code> is important because of the way my templates render article links (though my markdown source contains only relative links that work anywhere). And <code>paths.output root</code> just specifies the build directory where the HTML files get written.</p>
<p>All the moving parts are contained in <a href="https://github.com/robjwells/primaryunit/blob/master/makefile">a makefile</a> which can build all three of my destinations. Here it is in full:</p>
<div class="syntax"><pre><span></span><span class="nv">NOW</span> <span class="o">=</span> <span class="k">$(</span>shell date +<span class="s1">&#39;%Y-%m-%d %H:%M&#39;</span><span class="k">)</span>
<span class="nv">DISTID</span> <span class="o">=</span> <span class="k">$(</span>shell cat cloudfront-distribution-id<span class="k">)</span>


<span class="cp">define upload-robjwells</span>
<span class="err">rsync</span> <span class="err">-zv</span> <span class="err">-e</span> <span class="err">ssh</span> <span class="err">www.robjwells.com.conf</span>
    <span class="nf">rick@deckard</span><span class="o">:</span>/<span class="n">srv</span>/<span class="n">www</span>/<span class="n">www</span>.<span class="n">robjwells</span>.<span class="n">com</span>/
<span class="err">rsync</span> <span class="err">-azv</span> <span class="err">--delete</span> <span class="err">-e</span> <span class="err">ssh</span> <span class="err">site/</span>
    <span class="nf">rick@deckard</span><span class="o">:</span>/<span class="n">srv</span>/<span class="n">www</span>/<span class="n">www</span>.<span class="n">robjwells</span>.<span class="n">com</span>/<span class="n">html</span>/
<span class="cp">endef</span>


<span class="cp">define upload-github</span>
<span class="err">cd</span> <span class="err">gh-pages</span> <span class="err">;</span> <span class="err">git</span> <span class="err">add</span> <span class="err">.</span> <span class="err">;</span> <span class="err">git</span> <span class="err">commit</span> <span class="err">-m</span> <span class="s2">&quot;$(NOW)&quot;</span> <span class="err">;</span> <span class="err">git</span> <span class="err">push</span>
<span class="cp">endef</span>


<span class="cp">define upload-aws</span>
<span class="nf">aws s3 sync s3 s3</span><span class="o">:</span>//<span class="n">s</span>3.<span class="n">robjwells</span>.<span class="n">com</span> --<span class="n">delete</span>
<span class="err">aws</span> <span class="err">cloudfront</span> <span class="err">create-invalidation</span>
    <span class="nv">--distribution-id</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>DISTID<span class="k">)</span><span class="s2">&quot;</span> --paths<span class="o">=</span>/index.html
<span class="cp">endef</span>


<span class="nf">all</span><span class="o">:</span> <span class="n">robjwells</span> <span class="n">github</span> <span class="n">aws</span>

<span class="nf">force-all</span><span class="o">:</span> <span class="n">force</span>-<span class="n">robjwells</span> <span class="n">force</span>-<span class="n">github</span> <span class="n">force</span>-<span class="n">aws</span>

<span class="nf">robjwells</span><span class="o">:</span>
  majestic
  <span class="k">$(</span>upload-robjwells<span class="k">)</span>

<span class="nf">force-robjwells</span><span class="o">:</span>
  majestic --force-write
  <span class="k">$(</span>upload-robjwells<span class="k">)</span>

<span class="nf">github</span><span class="o">:</span>
  majestic --settings<span class="o">=</span>robjwells.github.io.json
  <span class="k">$(</span>upload-github<span class="k">)</span>

<span class="nf">force-github</span><span class="o">:</span>
  majestic --settings<span class="o">=</span>robjwells.github.io.json --force-write
  <span class="k">$(</span>upload-github<span class="k">)</span>

<span class="nf">aws</span><span class="o">:</span>
  majestic --settings<span class="o">=</span>s3.robjwells.com.json
  <span class="k">$(</span>upload-aws<span class="k">)</span>

<span class="nf">force-aws</span><span class="o">:</span>
  majestic --settings<span class="o">=</span>s3.robjwells.com.json --force-write
  <span class="k">$(</span>upload-aws<span class="k">)</span>
</pre></div>


<p>(The <code>force-*</code> options rebuild the whole site, not just files which have changed.)</p>
<p>And, really, that’s all it takes to publish to multiple hosts (once you’re set up at each one, of course).</p>
<p>My own server is just a vanilla rsync command, with an extra one because I keep my Nginx server config locally too.</p>
<p>For GitHub pages the <code>gh-pages</code> folder is a git repository, so <code>make github</code> regenerates the site into that folder, commits the changes with a timestamp as the message, and pushes the changes to GitHub. (It’s all on the same line with semicolons because the <code>cd</code> into the directory doesn’t hold across lines in the makefile.) Because the GitHub repository is set up to publish, the rest is sorted out on their end.</p>
<p>And for S3 I just use the official AWS tool (<code>brew install awscli</code> if you’re on macOS) — the CloudFront line is because I use it to speed up the S3 version and I want to make sure an updated front page is available reasonably quickly, if not anything else.</p>
<p>There’s a bit of overhead setting all of these up but once you do it doesn’t have to be any more work to keep each host updated. For me it’s just a <code>make all</code> away.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/page-speed/">Page speed</a></h2>
      <p><time datetime="2017-04-10T10:40">Monday, April 10 2017</time></p>
    </header>
    <p>Since I moved the blog off Tumblr, I’ve tried to make it reasonably quick. Reasonably because it’s come in waves — waves of me saying: “Oh, that’s fine” and then deciding that whatever it is isn’t fine and needs to go.</p>
<p>Tumblr used to whack in about 1MB of extra guff for its own purposes. If you’re posting endless gifs then that’s not something you’ll notice, but when you’re mostly dealing in text it’s pretty obvious.</p>
<p>When I <a href="/2013/07/five-different-kinds-of-grey/">redesigned the site</a> almost four years ago I remember chafing at this, but it wasn’t until I settled on <a href="https://github.com/robjwells/majestic/">my own site generator</a> that I had the chance to really whittle things down.</p>
<p>Much of that was lopping off unneeded stuff such as jQuery. It did succeed in getting the size down — to about 150–200kB for an average post. But I’ve recently made a few changes to speed things up that I wanted to talk about.</p>
<p>Much of this has come about after reading Jacques Mattheij’s <a href="https://jacquesmattheij.com/the-fastest-blog-in-the-world">The Fastest Blog in the World</a> and Dan Luu’s two excellent posts <a href="https://danluu.com/octopress-speedup/">Speeding up this blog by 25x-50x</a> and <a href="https://danluu.com/web-bloat/">Most of the web really sucks if you have a slow connection</a>. (And, well, of course, <a href="http://idlewords.com/talks/website_obesity.htm">Maciej</a>. You should really read that one.)</p>
<h3>Fonts</h3>
<p>For ages this site used <a href="https://typekit.com/fonts/rooney">Rooney</a> served by Typekit as its main font. I <em>love</em> Rooney, it’s great. But using web fonts always means sending lots of data.</p>
<p>Despite thinning down the included characters (Typekit allows you to choose language support) and forgoing the use of double emphasis (<code>&lt;em&gt;&lt;strong&gt;</code>), serving up three weights of Rooney still clocked in at over 100kB.</p>
<p>I’m looking at Rooney now and it is gorgeous, but there’s no way I could or can justify it — the fonts collectively would usually outweigh anything else on a page. So it went, in favour of Trebuchet MS, which I’ve long had a soft spot for.</p>
<h3>DNS</h3>
<p>Not related to the bytes served up but switching my registrar’s (<a href="https://www.hover.com">Hover</a>’s) name servers for <a href="https://www.cloudflare.com">Cloudflare</a> helped cut about 100ms in DNS response times (from about 150ms).</p>
<p>You can host your DNS with Cloudflare for free without using any of their other caching services (I don’t), and Cloudflare is consistently <a href="http://www.dnsperf.com">one of the fastest DNS hosts in the world</a>.</p>
<h3>Syntax highlighting</h3>
<p>Up until now I’d been using <a href="https://highlightjs.org">highlighting.js</a> to colour code snippets, and I’d been very happy with it. It’s a nice library that’s easy to work with and easy to download a customised version for your own use.</p>
<p>But I’d been handing out a 10kB JavaScript library to everyone who visited — whether there was code to be highlighted or not. Had I included more than a handful of languages in my library it would have been even more.</p>
<p>My first decision was to use my <a href="https://github.com/robjwells/majestic/">blog generator</a>’s extensions mechanism to mark every post or page that included code and would need highlighting — so if you visited a page without code, you didn’t receive the JavaScript library.</p>
<p>But really that wasn’t enough for me. A few things annoyed me:</p>
<ul>
<li>Syntax highlighting had to be performed on every view on the client device at readers’ expense.</li>
<li>I could only highlight those languages I’d included in my library.</li>
<li>The library included all of my selected languages no matter what was on the page.</li>
</ul>
<p>This wasn’t ideal.</p>
<p>The <a href="https://pythonhosted.org/Markdown/">Markdown module</a> I use has support for syntax highlighting, but there were <a href="http://www.leancrew.com/all-this/2010/12/new-syntax-highlighting-for-markdown/">some deficiencies</a> with it that had led me to pick the client-side highlighter in the first place, several years ago.</p>
<p>It wasn’t difficult to fix that, however. Taking inspiration from <a href="https://alexwlchan.net/2017/03/extensions-in-python-markdown/">Alex Chan</a>, I modified the included Codehilite extension to match my requirements, which were to handle a “natural-looking” language line and line numbers in the Markdown source. You can <a href="https://github.com/robjwells/primaryunit/blob/master/extensions/rjw_highlight.py">see the source online</a>, but it’s pretty rough and I need to tidy it up. (It also uses Pygments’s inline line numbers, instead of the table approach which I’ve seen out of alignment on occasion.)</p>
<p>The tradeoff here was serving a slightly inflated HTML file but a much-reduced JavaScript file (I kept a <a href="https://github.com/robjwells/primaryunit/blob/master/frontend/js/robjwells.js">barebones script</a> of a tenth of the size to show the plain source) — but the increase in HTML size is much smaller than the original JavaScript was.</p>
<p>In all, I’ve gone from a baseline of roughly 160kB to 10-15kB per image-free post. It’s not <a href="https://jacquesmattheij.com/the-fastest-blog-in-the-world">the fastest blog in the world</a>, especially if you’re far away from Linode’s London datacentre, but it should be pretty nippy.</p>
<h3>What else?</h3>
<p>There are some things which I’ve rejected so far.</p>
<ul>
<li>
<p>Inlining JavaScript and CSS.</p>
<p>This could make the page render faster, at the expense of transferring data that would otherwise be cached when viewing other pages. (But, assuming the blog is like most others, most will only visit a single page.)</p>
<p>But I feel a bit icky about munging separate resources together, and in mitigation the site is served over HTTP/2 (<a href="http://caniuse.com/#feat=http2">which most of the world supports</a>) and <a href="https://blog.cloudflare.com/http-2-for-web-developers/">inlining is an anti-pattern</a>.</p>
</li>
<li>
<p>Sack off the traditional front page.</p>
<p>Yeah, I felt this one acutely recently after posting all those dodgy but massive <a href="/2017/03/tube-crowding/">Tube heat maps</a>, sitting towards the bottom of the front page and inflating its size.</p>
<p><a href="https://danluu.com">Dan Luu</a> has his archives as the front page, which is svelte but extreme for my tastes. We’ll see about this one.</p>
</li>
<li>
<p>Ditch your CSS.</p>
<p><a href="http://motherfuckingwebsite.com">Yeah, I know</a>. (<a href="http://bettermotherfuckingwebsite.com">Well</a>.) But I like pretty things. And it’s only about 2.5kB.</p>
</li>
</ul>
  </article>
  <div class="pagination">
<p class="pagination-older"><a href="https://robjwells.github.io/page-5/">Older posts</a></p><p class="pagination-newer"><a href="https://robjwells.github.io/page-3/">Newer posts</a></p>  </div>

</main>

<footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> <!-- .site-footer -->

</div> <!-- .wrapper -->

</body>

</html>