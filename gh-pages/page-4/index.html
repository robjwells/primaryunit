<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Primary Unit mirror on GitHub – page 4</title>

  <!-- Load my combined stylesheet -->
  <link rel="stylesheet" href="/resources/all.min.css">


  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <link rel="alternate" type="application/rss+xml" title="RSS feed for Primary Unit" href="/rss">
  <link rel="alternate" type="application/json" title="JSON feed for Primary Unit" href="/feed.json">

  <!-- Apple pinned sites icon, Apple touch icon, Favicon -->
  <link rel="mask-icon" href="/resources/favicon.svg" color="#1369BF">
  <link rel="apple-touch-icon-precomposed" href="/resources/favicon.png">
  <link rel="icon" href="/resources/favicon.ico">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A mirror of https://www.robjwells.com hosted on GitHub">
</head>

<body>

<div class="wrapper">

<header class="site-header">

  <div class="site-title-container mute-links">
    <h1 class="site-title"><a href="https://robjwells.github.io">Primary Unit mirror on GitHub</a></h1>
    <p class="site-byline"><i>by</i> Rob Wells</p>
  </div>

  <div class="site-menu-container">

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/archives/">Archives</a></li>
        <li><a href="/feed.json">JSON&nbsp;feed</a></li>
        <li><a href="/rss">RSS&nbsp;feed</a></li>
      </ul>
    </nav>

    <label for="search-field" class="site-search-label">
      Site search
    </label>
    <form id="site-search" class="site-search" method="get" action="https://duckduckgo.com/">
      <input name="q" type="text" id="search-field" class="search-field" placeholder="via DuckDuckGo">
      <input name="sites" value="https://robjwells.github.io" hidden>
      <button type="submit" class="search-button">Search</button>
    </form>

  </div> <!-- .site-menu-container -->

</header> <!-- .site-header -->

<main role="main">

  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/centrism/">Centrism</a></h2>
      <p><time datetime="2017-04-24T00:05">Monday, April 24 2017</time></p>
    </header>
    <p>Diamond Geezer <a href="http://diamondgeezer.blogspot.co.uk/2017/04/left-right.html">asks</a>: “Why do we never end up in the middle?”</p>
<p>It’s unfair to pick on him, but I will because he posted on a day when my annoyance at centrist liberals has well and truly peaked.</p>
<p>First off, the “centre ground” is a concept that is entirely relative. When Jeremy Corbyn campaigned to become and was elected leader of the Labour Party in 2015, he managed to shift the centre ground — the Tories very quickly ditched a plan to bomb the Syrian government.</p>
<p>The centre ground is inherently unstable because it only exists relative to the two dominant forces either side. At our present moment that’s a fairly right-wing Conservative Party and a reasonably social democratic Labour Party. Any “centrist” must define themselves in opposition to their closest opponents on the left and right.</p>
<p>Ultimately if you do that it means you have no principles, nothing that anchors you on the left-right axis. In reality — as much as we joke about spineless politicians — few define their positions in this way and instead the “centre” in various countries is the home to a party that has “right-wing” economic policies and “left-wing” social policies. In Britain that would be the Liberal Democrats, despite Tim Farron’s recent attempts to win over the homophobes.</p>
<p>Left and right are in scare quotes above because this shows the point at which the left-right axis breaks down.</p>
<p>Ultimately the idea of centrism is bankrupt. Politics is a clash of interests. The ideas of the “centre ground,” of the “national interest,” are rubbish. Howard Zinn put it best in his People’s History of the United States:</p>
<blockquote>
<p>Nations are not communities and never have been. The history of any country, presented as the history of a family, conceals the fierce conflicts of interest (sometimes exploding, often repressed) between conquerors and conquered, masters and slaves, capitalists and workers, dominators and dominated in race and sex.</p>
</blockquote>
<p>As a socialist, to use our compromised axis, the boss class sits on the right and the workers on the left. Given that the boss class is but a tiny sliver of the population, what credibility does a “centrist” party have, one that pretends to balance the desires of the exploited and the exploiters?</p>
<p>It this this “refreshing centrism” that irks me the most, as it is always right-wing economic policies paired with some ameliorating factor — support for gay marriage, say — to assuage the liberals.</p>
<p>But if you’re gay, does being able to officially consecrate your relationship make up for the fact that you spend half your wages on rent?</p>
<p>This has run on, so let’s talk about Emmanuel Macron. <a href="https://www.theguardian.com/commentisfree/2017/apr/23/the-guardian-view-on-france-election-a-win-for-macron-and-hope">The Guardian loves him</a>, noting (without the expected contradicting clause) that it “is tempting … to conclude that European liberal values have successfully rallied to stop another lurch to the racist right.”</p>
<p>And so Macron, an explicit neoliberal, is raised up having defeated (we’ll see) the fascist Marine Le Pen.</p>
<p>The celebration is of liberal values, embodied by Macron. But Macron’s liberal values go a long way to explain the surge in support for France’s fascist National Front, as <a href="http://wpj.dukejournals.org/content/34/1/18.full">Cole Stangler shows</a>. His liberal values are likely to increase “<a href="https://www.dissentmagazine.org/online_articles/french-election-trouble-with-emmanuel-macron-centrism">unemployment, inequality and poverty</a>” through his right-wing economic policies — along the lines of the French law that bears his name (loi Macron) and hacked away at workers’ rights.</p>
<p>The assault on workers’ rights and public services has been ongoing for nearly 40 years yet liberals and centrists deride the term that describes our current phase: neoliberalism.</p>
<p>The refusal to recognise this trend puts us in a position where the Guardian celebrates the likely victory of Macron, cheering his defeat of the fascists in blissful ignorance. But his political current is the reason why we have ended up with the fascists contesting the second round of the French presidential election (<a href="https://en.wikipedia.org/wiki/French_presidential_election,_2002">again</a>).</p>
<p>Faced with falling employment and living standards for four decades and (generally) abandoned by the organised left, people have turned to those who promise to take action to improve their material conditions.</p>
<p>Yet Macron’s policies will just exacerbate these problems. This isn’t the end of the fascist challenge in France; should Macron win and pursue his neoliberal programme we could well be in the same situation in five years’ time.</p>
<p>(Unless, potentially, the French left organises a strong anti-fascist campaign like that waged in Britain from the 1970s to the present time, in which the fascists have more or less been suffocated.)</p>
<p>This isn’t a “bold break with the past,” it is the continuation of the rule of the boss class with a fresh coat of paint.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/indesign-pdf-metastasis/">InDesign PDF metastasis</a></h2>
      <p><time datetime="2017-04-17T22:25">Monday, April 17 2017</time></p>
    </header>
    <p>At work we deal a lot with PDFs, both press quality and low-quality for viewing on screen. Over time I’ve automated a fair amount of the creation for both types, but one thing that I haven’t yet done is automate file-size reductions for the low-quality PDFs.</p>
<p>(We still use InDesign CS4 at work, so bear in mind that some or all of the below may not apply to more recent versions.)</p>
<p>It’s interesting to look at exactly what is making the files large enough to require slimming down in the first place. All our low-quality PDFs are exported from InDesign with the built-in “Smallest file size” preset, but the sizes are usually around 700kB for single tabloid-sized, image-sparse pages.</p>
<p><img src="/images/2017-04-17-arts-full.jpg"
     class="pull-right"
     alt="A low-quality image of a Morning Star arts page."></p>
<p>Let’s take Tuesday’s arts page as our example. It’s pretty basic: two small images and a medium-sized one, two drop shadows, one transparency and a fair amount of text. (That line of undermatter in the lead article was corrected before we went to print.)</p>
<p>But exporting using InDesign’s lowest-quality PDF preset creates a 715kB file. The images are small and rendered at a low DPI, so they’re not inflating the file.</p>
<p>Thankfully you can have a poke around PDF files with your favourite text editor (<a href="http://www.barebones.com/products/bbedit/">BBEdit</a>, obviously). You’ll find a lot of “garbage” text, which I imagine is chunks of binary data, but there’s plenty of plain text you can read. The big chunks tend to be metadata. Here’s part of the first metadata block in the PDF file for the arts page:</p>
<pre><code>&lt;x:xmpmeta xmlns:x=&quot;adobe:ns:meta/&quot; x:xmptk=&quot;Adobe XMP […]&quot;&gt;
 &lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;
  &lt;rdf:Description rdf:about=&quot;&quot;
    xmlns:xmp=&quot;http://ns.adobe.com/xap/1.0/&quot;
    xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;
    xmlns:photoshop=&quot;http://ns.adobe.com/photoshop/1.0/&quot;
    … Blah blah blah exif data etc …
  &lt;/rdf:Description&gt;
 &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;</code></pre>


<p>Which is the none-too-exciting block for one of the images, a Photoshop file. There’s two more like this, roughly 50–100 lines each. Then we hit a chunk which describes the InDesign file itself, with this giveaway line:</p>
<pre><code>&lt;xmp:CreatorTool&gt;Adobe InDesign CS4 (6.0.6)&lt;/xmp:CreatorTool&gt;</code></pre>


<p>So what, right? InDesign includes some document and image metadata when it exports a PDF. Sure, yeah. I mean, the metadata blocks for the images weren’t too long, and this is just about their container.</p>
<p>Except this InDesign metadata block is 53,895 lines long in a file that’s 86,585 lines long. 574,543 characters of the document’s 714,626 — 80% of the file.</p>
<p>I think it’s safe to say we’ve found our culprit. But what’s going on in those 54,000 lines? Well, mostly this:</p>
<pre><code>&lt;xmpMM:History&gt;
   &lt;rdf:Seq&gt;
      &lt;rdf:li rdf:parseType=&quot;Resource&quot;&gt;
         &lt;stEvt:action&gt;created&lt;/stEvt:action&gt;
         &lt;stEvt:instanceID&gt;xmp.iid:[… hex ID …]&lt;/stEvt:instanceID&gt;
         &lt;stEvt:when&gt;2012-05-22T12:55:27+01:00&lt;/stEvt:when&gt;
         &lt;stEvt:softwareAgent&gt;Adobe InDesign 6.0&lt;/stEvt:softwareAgent&gt;
      &lt;/rdf:li&gt;
      &lt;rdf:li rdf:parseType=&quot;Resource&quot;&gt;
         &lt;stEvt:action&gt;saved&lt;/stEvt:action&gt;
         &lt;stEvt:instanceID&gt;xmp.iid:[… hex ID …]&lt;/stEvt:instanceID&gt;
         &lt;stEvt:when&gt;2012-05-22T12:55:54+01:00&lt;/stEvt:when&gt;
         &lt;stEvt:softwareAgent&gt;Adobe InDesign 6.0&lt;/stEvt:softwareAgent&gt;
         &lt;stEvt:changed&gt;/&lt;/stEvt:changed&gt;
      &lt;/rdf:li&gt;
    &lt;!--  1,287 more list items  --&gt;
   &lt;/rdf:Seq&gt;
&lt;/xmpMM:History&gt;</code></pre>


<p>It’s effectively a record of every time the document was saved. But if you look at the <code>stEvt:when</code> tag you’ll notice the first items are from 2012 — when our “master” InDesign file from which we derive our edition files was first created. So, the whole record of that master file is included in every InDesign file we use, and the PDFs we create from them.</p>
<p>Can we remove this metadata from InDesign? You can see it in <span class="osx-menu">File ▸ File Info… ▸ Advanced</span>, select it and press the rubbish bin icon. Save, quit, reopen and… it’s still there.</p>
<p>Thankfully Acrobat can remove this stuff from your final PDF, by going through the “PDF Optimizer” or “Save Optimized PDF” or whatever menu item it’s hiding under these days. (In the “Audit Space Usage” window it corresponds to the “Document Overhead”.)</p>
<p>Unfortunately Acrobat’s AppleScript support has always been poor — I’ve no idea what it’s like now, remember we’re talking CS4 — and I’ve no time nor desire to dive into Adobe’s JavaScript interface. So while you can (and we do) automate the PDF exports, you can’t slim these files down automatically with Acrobat.</p>
<p>Our solution at work has been to cut the cruft from the PDF using Acrobat when we use it to combine our separate page PDFs by hand. But ultimately I want to automate the whole process of exporting the PDFs, stitching them together in order, and reducing the file size.</p>
<p>After using <a href="https://ghostscript.com">ghostscript</a> for our <a href="https://github.com/ppps/ms-barcode">automatic barcode creation</a>, I twigged that it would be useful for processing the PDFs after creation, and sure enough you can use it to slim down PDFs. Here’s an example command:</p>
<pre><code>gs -sDEVICE=pdfwrite \
   -dPDFSETTINGS=/screen \
   -dCompatibilityLevel=1.5 \
   -dNOPAUSE -dQUIET -dBATCH \
   -sOutputFile=&quot;11_Books_180417-smaller.pdf&quot; \
   &quot;11_Books_180417.pdf&quot;</code></pre>


<p>Most of that is ghostscript boilerplate (it’s not exactly the friendliest tool to use), but the important option is <code>-dPDFSETTINGS=/screen</code> which, according to <a href="https://ghostscript.com/doc/9.14/Ps2pdf.htm#Options">one page of the sprawling docs</a>, is a predefined Adobe Distiller setting.</p>
<p>Using it on our 715kB example spits out an 123kB PDF that is visually identical apart from mangling the drop shadows (which I think can be solved by changing the transparency flattening settings when the PDF is exported from InDesign).</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/redundant-publishing/">Redundant publishing</a></h2>
      <p><time datetime="2017-04-16T22:39">Sunday, April 16 2017</time></p>
    </header>
    <p>In my previous post about <a href="/2017/04/page-speed/">page speed</a>, I mentioned that I’d written <a href="https://github.com/robjwells/majestic">my own site generator</a>. I’m not quite ready to talk specifically about it — I want to write some documentation first — and really I doubt that anyone but me <em>should</em> be using it.</p>
<p>But, having set up <a href="https://s3.robjwells.com">publishing to Amazon S3</a> today, I wanted to write up how I publish this blog to multiple places so that it’ll be around whatever (within reason) might happen.</p>
<p><a href="https://github.com/robjwells/majestic">Majestic</a>’s configuration files are set up in such a way that you have have a default settings file in a directory — <code>settings.json</code> — and you can specify others that make adjustments to that.</p>
<p>In my case the main settings file contains the configuration for publishing to my own server (hosted at Linode) — not the nitty gritty of how to get it on to the server, but what the URLs, site title, etc should be. (It’s online if you want to <a href="https://github.com/robjwells/primaryunit/blob/master/settings.json">have a nose around</a>.)</p>
<p>Then I have two extra JSON files: <code>robjwells.github.io.json</code> and <code>s3.robjwells.com.json</code>, which contain the customisations for publishing for those domains. Here’s the config for GitHub in full:</p>
<pre><code>{
  &quot;site&quot;: {
    &quot;url&quot;: &quot;https://robjwells.github.io&quot;,
    &quot;title&quot;: &quot;Primary Unit mirror on GitHub&quot;,
    &quot;description&quot;: &quot;A mirror of https://www.robjwells.com hosted on GitHub&quot;
  },

  &quot;paths&quot;: {
    &quot;output root&quot;: &quot;gh-pages&quot;
  }
}</code></pre>


<p>Setting <code>site.url</code> is important because of the way my templates render article links (though my markdown source contains only relative links that work anywhere). And <code>paths.output root</code> just specifies the build directory where the HTML files get written.</p>
<p>All the moving parts are contained in <a href="https://github.com/robjwells/primaryunit/blob/master/makefile">a makefile</a> which can build all three of my destinations. Here it is in full:</p>
<pre><code>NOW = $(shell date +'%Y-%m-%d %H:%M')
DISTID = $(shell cat cloudfront-distribution-id)


define upload-robjwells
rsync -zv -e ssh www.robjwells.com.conf
    rick@deckard:/srv/www/www.robjwells.com/
rsync -azv --delete -e ssh site/
    rick@deckard:/srv/www/www.robjwells.com/html/
endef


define upload-github
cd gh-pages ; git add . ; git commit -m &quot;$(NOW)&quot; ; git push
endef


define upload-aws
aws s3 sync s3 s3://s3.robjwells.com --delete
aws cloudfront create-invalidation
    --distribution-id=&quot;$(DISTID)&quot; --paths=/index.html
endef


all: robjwells github aws

force-all: force-robjwells force-github force-aws

robjwells:
  majestic
  $(upload-robjwells)

force-robjwells:
  majestic --force-write
  $(upload-robjwells)

github:
  majestic --settings=robjwells.github.io.json
  $(upload-github)

force-github:
  majestic --settings=robjwells.github.io.json --force-write
  $(upload-github)

aws:
  majestic --settings=s3.robjwells.com.json
  $(upload-aws)

force-aws:
  majestic --settings=s3.robjwells.com.json --force-write
  $(upload-aws)</code></pre>


<p>(The <code>force-*</code> options rebuild the whole site, not just files which have changed.)</p>
<p>And, really, that’s all it takes to publish to multiple hosts (once you’re set up at each one, of course).</p>
<p>My own server is just a vanilla rsync command, with an extra one because I keep my Nginx server config locally too.</p>
<p>For GitHub pages the <code>gh-pages</code> folder is a git repository, so <code>make github</code> regenerates the site into that folder, commits the changes with a timestamp as the message, and pushes the changes to GitHub. (It’s all on the same line with semicolons because the <code>cd</code> into the directory doesn’t hold across lines in the makefile.) Because the GitHub repository is set up to publish, the rest is sorted out on their end.</p>
<p>And for S3 I just use the official AWS tool (<code>brew install awscli</code> if you’re on macOS) — the CloudFront line is because I use it to speed up the S3 version and I want to make sure an updated front page is available reasonably quickly, if not anything else.</p>
<p>There’s a bit of overhead setting all of these up but once you do it doesn’t have to be any more work to keep each host updated. For me it’s just a <code>make all</code> away.</p>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/04/page-speed/">Page speed</a></h2>
      <p><time datetime="2017-04-10T10:40">Monday, April 10 2017</time></p>
    </header>
    <p>Since I moved the blog off Tumblr, I’ve tried to make it reasonably quick. Reasonably because it’s come in waves — waves of me saying: “Oh, that’s fine” and then deciding that whatever it is isn’t fine and needs to go.</p>
<p>Tumblr used to whack in about 1MB of extra guff for its own purposes. If you’re posting endless gifs then that’s not something you’ll notice, but when you’re mostly dealing in text it’s pretty obvious.</p>
<p>When I <a href="/2013/07/five-different-kinds-of-grey/">redesigned the site</a> almost four years ago I remember chafing at this, but it wasn’t until I settled on <a href="https://github.com/robjwells/majestic/">my own site generator</a> that I had the chance to really whittle things down.</p>
<p>Much of that was lopping off unneeded stuff such as jQuery. It did succeed in getting the size down — to about 150–200kB for an average post. But I’ve recently made a few changes to speed things up that I wanted to talk about.</p>
<p>Much of this has come about after reading Jacques Mattheij’s <a href="https://jacquesmattheij.com/the-fastest-blog-in-the-world">The Fastest Blog in the World</a> and Dan Luu’s two excellent posts <a href="https://danluu.com/octopress-speedup/">Speeding up this blog by 25x-50x</a> and <a href="https://danluu.com/web-bloat/">Most of the web really sucks if you have a slow connection</a>. (And, well, of course, <a href="http://idlewords.com/talks/website_obesity.htm">Maciej</a>. You should really read that one.)</p>
<h3>Fonts</h3>
<p>For ages this site used <a href="https://typekit.com/fonts/rooney">Rooney</a> served by Typekit as its main font. I <em>love</em> Rooney, it’s great. But using web fonts always means sending lots of data.</p>
<p>Despite thinning down the included characters (Typekit allows you to choose language support) and forgoing the use of double emphasis (<code>&lt;em&gt;&lt;strong&gt;</code>), serving up three weights of Rooney still clocked in at over 100kB.</p>
<p>I’m looking at Rooney now and it is gorgeous, but there’s no way I could or can justify it — the fonts collectively would usually outweigh anything else on a page. So it went, in favour of Trebuchet MS, which I’ve long had a soft spot for.</p>
<h3>DNS</h3>
<p>Not related to the bytes served up but switching my registrar’s (<a href="https://www.hover.com">Hover</a>’s) name servers for <a href="https://www.cloudflare.com">Cloudflare</a> helped cut about 100ms in DNS response times (from about 150ms).</p>
<p>You can host your DNS with Cloudflare for free without using any of their other caching services (I don’t), and Cloudflare is consistently <a href="http://www.dnsperf.com">one of the fastest DNS hosts in the world</a>.</p>
<h3>Syntax highlighting</h3>
<p>Up until now I’d been using <a href="https://highlightjs.org">highlighting.js</a> to colour code snippets, and I’d been very happy with it. It’s a nice library that’s easy to work with and easy to download a customised version for your own use.</p>
<p>But I’d been handing out a 10kB JavaScript library to everyone who visited — whether there was code to be highlighted or not. Had I included more than a handful of languages in my library it would have been even more.</p>
<p>My first decision was to use my <a href="https://github.com/robjwells/majestic/">blog generator</a>’s extensions mechanism to mark every post or page that included code and would need highlighting — so if you visited a page without code, you didn’t receive the JavaScript library.</p>
<p>But really that wasn’t enough for me. A few things annoyed me:</p>
<ul>
<li>Syntax highlighting had to be performed on every view on the client device at readers’ expense.</li>
<li>I could only highlight those languages I’d included in my library.</li>
<li>The library included all of my selected languages no matter what was on the page.</li>
</ul>
<p>This wasn’t ideal.</p>
<p>The <a href="https://pythonhosted.org/Markdown/">Markdown module</a> I use has support for syntax highlighting, but there were <a href="http://www.leancrew.com/all-this/2010/12/new-syntax-highlighting-for-markdown/">some deficiencies</a> with it that had led me to pick the client-side highlighter in the first place, several years ago.</p>
<p>It wasn’t difficult to fix that, however. Taking inspiration from <a href="https://alexwlchan.net/2017/03/extensions-in-python-markdown/">Alex Chan</a>, I modified the included Codehilite extension to match my requirements, which were to handle a “natural-looking” language line and line numbers in the Markdown source. You can <a href="https://github.com/robjwells/primaryunit/blob/master/extensions/rjw_highlight.py">see the source online</a>, but it’s pretty rough and I need to tidy it up. (It also uses Pygments’s inline line numbers, instead of the table approach which I’ve seen out of alignment on occasion.)</p>
<p>The tradeoff here was serving a slightly inflated HTML file but a much-reduced JavaScript file (I kept a <a href="https://github.com/robjwells/primaryunit/blob/master/frontend/js/robjwells.js">barebones script</a> of a tenth of the size to show the plain source) — but the increase in HTML size is much smaller than the original JavaScript was.</p>
<p>In all, I’ve gone from a baseline of roughly 160kB to 10-15kB per image-free post. It’s not <a href="https://jacquesmattheij.com/the-fastest-blog-in-the-world">the fastest blog in the world</a>, especially if you’re far away from Linode’s London datacentre, but it should be pretty nippy.</p>
<h3>What else?</h3>
<p>There are some things which I’ve rejected so far.</p>
<ul>
<li>
<p>Inlining JavaScript and CSS.</p>
<p>This could make the page render faster, at the expense of transferring data that would otherwise be cached when viewing other pages. (But, assuming the blog is like most others, most will only visit a single page.)</p>
<p>But I feel a bit icky about munging separate resources together, and in mitigation the site is served over HTTP/2 (<a href="http://caniuse.com/#feat=http2">which most of the world supports</a>) and <a href="https://blog.cloudflare.com/http-2-for-web-developers/">inlining is an anti-pattern</a>.</p>
</li>
<li>
<p>Sack off the traditional front page.</p>
<p>Yeah, I felt this one acutely recently after posting all those dodgy but massive <a href="/2017/03/tube-crowding/">Tube heat maps</a>, sitting towards the bottom of the front page and inflating its size.</p>
<p><a href="https://danluu.com">Dan Luu</a> has his archives as the front page, which is svelte but extreme for my tastes. We’ll see about this one.</p>
</li>
<li>
<p>Ditch your CSS.</p>
<p><a href="http://motherfuckingwebsite.com">Yeah, I know</a>. (<a href="http://bettermotherfuckingwebsite.com">Well</a>.) But I like pretty things. And it’s only about 2.5kB.</p>
</li>
</ul>
  </article>
  <article>
    <header>
      <h2 class="mute-links"><a href="https://robjwells.github.io/2017/03/backups-the-change/">Backups: the change</a></h2>
      <p><time datetime="2017-03-21T01:05">Tuesday, March 21 2017</time></p>
    </header>
    <p>To recount from <a href="/2017/03/backups-before/">last time</a>, our backup strategy was a mess. The tools were solid but used in such a way that the common case (fast file restoration) was likely to fail, even if the rare case (complete disk failure) was covered.</p>
<p>That alone should have made me act sooner than I did. But ultimately the common case was so rare that the pain it caused wasn’t sufficiently motivating. That combined with an already set plan to make the change when the server hardware was changed, a reluctance to spend money that delayed the hardware change, and a near-total lack of time. So it didn’t happen for about 2.5 years after I got the job.</p>
<p>What finally prompted me to overhaul the backups was a nerve-wracking hour late last year when the Mac Mini server became unresponsive and would fail to start up with its external drives attached.</p>
<p>Detaching the drives, booting and then reattaching the drives got us back to normal. (This had happened before; I think it might have been connected to the third-party RAID driver we were using, but I don’t know that for sure.)</p>
<p>As a precaution I checked the server’s backups. None had completed in five days. Understand that there was no monitoring; checking required logging in to the machine and looking at the Arq interface and SuperDuper’s schedule.</p>
<p>The <a href="https://www.arqbackup.com">Arq</a> agent had hung and I believe <a href="http://www.shirt-pocket.com">SuperDuper</a> had too, just frozen in the middle of a scheduled copy. As I noted <a href="/2017/03/backups-before/">before</a>, these are both solid pieces of software so I’m very much blaming the machine itself and the way it was set up.</p>
<p>Shortly after I ordered a replacement Mac Mini (with a 1TB <a href="https://support.apple.com/en-gb/HT202574">Fusion</a> drive that feels nearly as fast as my SSD at home) and a bunch of new external drives.</p>
<h3>Hardware</h3>
<p>Previously we had been using various 3.5″ drives in various enclosures.</p>
<p>I don’t know what the professional advice about using internal drives in enclosures versus external drives, but my preference is for “real” external drives, mostly because they’re better-designed when it comes to using several of them, they seem to be better ventilated and quieter, and they’re less hassle.</p>
<p>All of our existing drives were several years old, the newest 2.5 years (and I managed to brick that one through impatience — a separate story), so they all needed replacing.</p>
<p>I bought four <a href="http://www.techradar.com/reviews/pc-mac/pc-components/storage/toshiba-4tb-canvio-usb-3-0-external-hard-drive-1261227/review">4TB USB3 Toshiba</a> drives, which run at 7,200 RPM using drives apparently manufactured by someone else. That <a href="http://www.techradar.com/reviews/pc-mac/pc-components/storage/toshiba-4tb-canvio-usb-3-0-external-hard-drive-1261227/review">review</a> says they’re noisy, but I’ve had all four next to my desk (in an office) since the start of the year, with at least one reading constantly (more on that later), and they’re OK. I might feel differently if I was using one in my quiet bedroom at home, but it’s hard to tell.</p>
<p>Funnily enough, you can no longer buy these drives from the retailer where we got them. But from memory they were about £100 each, maybe a bit less.</p>
<p>More recently I bought a 1TB USB3 Toshiba Canvio 2.5″ external drive to serve as a SuperDuper clone. (Not to match the 4TB Toshiba drives, but because it was well reviewed and cheaper than others.)</p>
<p>In sum, here’s our stock of drives:</p>
<ul>
<li>1 in the Mac Mini. (You can’t buy dual-drive Minis anymore.)</li>
<li>2 Time Machine drives.</li>
<li>1 nightly SuperDuper clone.</li>
<li>1 for the 2002-2016 archives.</li>
<li>1 for the post-2016 archives.</li>
</ul>
<h4>Redundancy</h4>
<p>One of the biggest changes is one that’s basically invisible. Beforehand we had loads of drives, not all of which I mentioned last time.</p>
<ul>
<li>2 in the Mac Mini server.</li>
<li>2 for daily/3-hourly clones (each drive containing two partitions).</li>
<li>2 for the 2002-2011 archives.</li>
<li>2 for the post-2011 archives.</li>
</ul>
<p>All of them were in <a href="https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_1">RAID 1</a>, where each drive contains a copy of the data. The idea behind this is that one drive can fail and you can keep going.</p>
<p>We were using a third-party RAID driver by a long-standing vendor. I won’t name them because I didn’t get on with the product, but I don’t want to slight it unfairly.</p>
<p>The RAID software frequently cried wolf — including on a new external drive that lasted 2.5 years until I broke it accidentally — so I got to a point where I just didn’t believe any of its warnings.</p>
<p>The worst was a pop-up once a day warning that one of the drives inside the Mini was likely to fail within the next few weeks. I got that message for over two years. I’d only infrequently log in to the Mini, so I’d have to click through weeks of pop-ups. The drive still hasn’t died.</p>
<p>As I’ve made clear, the machine itself was a pain to work with and that may have been the root problem. But I won’t be using the RAID driver again.</p>
<p>That experience didn’t encourage me to carry over the RAID setup, but the main factor in deciding against using RAID was cost. As we openly admit in the paper, our place isn’t flush with cash so we try to make the best use of what we’ve got.</p>
<p>The demise of the dual-drive Mini means that the internal drive isn’t mirrored, and that would have been the obvious candidate. So if I were to buy extra drives for a RAID mirror, it might be for the external archive drives. They are backed up but if either drive were to snuff it most of their contents would be unavailable for a period.</p>
<p>But buying mirror drives means that money isn’t available for other, more pressing needs.</p>
<h3>Backup strategy</h3>
<p>OK, with that out of the way, let’s talk about what we <em>are</em> doing now. In short:</p>
<ul>
<li>Time Machine backups every 20 minutes, rotated between two drives.</li>
<li>Nightly SuperDuper clones to a dedicated external drive.</li>
<li>Arq backups once an hour.</li>
<li>“Continuous” <a href="https://www.backblaze.com">Backblaze</a> backups.</li>
</ul>
<h4>Time Machine</h4>
<p>I’m a big fan of Time Machine; I’ve been using it for years and very rarely had problems. But Time Machine <a href="http://mjtsai.com/blog/tag/timemachine/">does have</a> <a href="https://joeontech.net//why-i-dont-rely-on-time-machine.html">problems</a>. I wouldn’t recommend using Time Machine by itself, particularly not if you’ve just got a single external disk.</p>
<p>There are a couple of reasons for using two drives for Time Machine:</p>
<ul>
<li>Keep backup history if one drive dies.</li>
<li>Perform backups frequently without unduly stressing a drive.</li>
<li>Potentially a better chance of withstanding <a href="https://joeontech.net//why-i-dont-rely-on-time-machine.html">a Time Machine problem</a>. (Perhaps? Fortunately this hasn’t happened to me yet.)</li>
</ul>
<p>Because of the nature of our work in the newsroom, a lot can change with a page or an article in a very short span of time, yet as we approach deadline there may not be any time to recreate lost work. So I run Time Machine every 20 minutes via a script.</p>
<p>It started off life as <a href="https://nathangrigg.com/2014/03/automounting-time-machine">a shell script by Nathan Grigg</a>, which I was first attracted to because at home my Time Machine drives sit next to my iMac — so between backups I wanted them unmounted and not making any noise. I’ve since recreated it in Python and expanded its logging.</p>
<p>Here’s the version I use at home:</p>
<pre><code>#!/usr/local/bin/python3
&quot;&quot;&quot;Automatically start TimeMachine backups, with rotation&quot;&quot;&quot;

from enum import Enum
import logging
from pathlib import Path
import subprocess

logging.basicConfig(
  level=logging.INFO,
  style='{',
  format='{asctime}  {levelname}  {message}',
  datefmt='%Y-%m-%d %H:%M'
)

TM_DRIVE_NAMES = [
  'HG',
  'Orson-A',
  'Orson-B',
  ]

DiskutilAction = Enum('DiskutilAction', 'mount unmount')


def _diskutil_interface(drive_name: str, action: DiskutilAction) -&gt; bool:
  &quot;&quot;&quot;Run diskutil through subprocess interface

  This is abstracted out because other the two (un)mounting functions
  would duplicate much of their code.

  Returns True if the return code is 0 (success), False on failure
  &quot;&quot;&quot;
  args = ['diskutil', 'quiet', action.name] + [drive_name]
  return subprocess.run(args).returncode == 0


def mount_drive(drive_name):
  &quot;&quot;&quot;Try to mount drive using diskutil and return status code&quot;&quot;&quot;
  return _diskutil_interface(drive_name, DiskutilAction.mount)


def unmount_drive(drive_name):
  &quot;&quot;&quot;Try to unmount drive using diskutil and return status code&quot;&quot;&quot;
  return _diskutil_interface(drive_name, DiskutilAction.unmount)


def begin_backup():
  &quot;&quot;&quot;Back up using tmutil and return backup summary&quot;&quot;&quot;
  args = ['tmutil', 'startbackup', '--auto', '--rotation', '--block']
  result = subprocess.run(
    args,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE
    )
  if result.returncode == 0:
    return (result.returncode, result.stdout.decode('utf-8'))
  else:
    return (result.returncode, result.stderr.decode('utf-8'))


def main():
  drives_to_eject = []

  for drive_name in TM_DRIVE_NAMES:
    if Path('/Volumes', drive_name).exists():
      continue
    elif mount_drive(drive_name):
      drives_to_eject.append(drive_name)
    else:
      logging.warning(f'Failed to mount {drive_name}')

  logging.info('Beginning backup')
  return_code, log_messages = begin_backup()
  log_func = logging.info if return_code == 0 else logging.warning
  for line in log_messages.splitlines():
    log_func(line)
  logging.info('Backup finished')

  for drive_name in drives_to_eject:
    if not unmount_drive(drive_name):
      logging.warning(f'Failed to unmount {drive_name}, trying again…')
      if not unmount_drive(drive_name):
        logging.warning(
          f'Failed to unmount {drive_name} on second attempt')

if __name__ == '__main__':
  main()</code></pre>


<p>The basic idea is the same: mount the backup drives if they’re not already, perform the backup using <code>tmutil</code>, and eject the drives that were mounted by the script afterwards. There’s nothing tricky in the script, except maybe the enum on line 22 — that’s to replace strings and risking a typo.</p>
<p>The arguments to <code>tmutil</code> on line 49 get Time Machine to behave as if it were running its ordinary, automatic hourly backups. The <a href="https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man8/tmutil.8.html"><code>tmutil</code> online man page</a> is out of date but does contain information on those options.</p>
<p>The version at work is the same except that it contains some code to skip backups overnight:</p>
<pre><code>TIME_LIMITS = (8, 23)

def check_time(time, limits=TIME_LIMITS):
  &quot;&quot;&quot;Return True if backup should proceed based on time of day&quot;&quot;&quot;
  early_limit, late_limit = limits
  return early_limit &lt;= time &lt;= late_limit

# And called like so:
check_time(datetime.now().hour)</code></pre>


<p>This was written pretty late at night so it’s not the best, but it does work.</p>
<h4>SuperDuper!</h4>
<p><a href="http://www.shirt-pocket.com">SuperDuper</a> is great, if you use it as it’s meant to be used. It runs after everyone’s gone home each evening.</p>
<p>I don’t look forward to booting from the 2.5″ clone drive but an external SSD was too expensive. In any case, should the Mini’s internal drive die the emergency plan is just to set up file sharing on one of our two SSD-equipped iMacs, copy over as many files as needed, and finish off the paper.</p>
<p>We’ve done this before when our internal network went down (a dead rack switch) and when a fire (at a nearby premises) forced us to produce the paper from a staff member’s kitchen. If such a thing happens again and the Mini is still functioning, I’d move that too as it’s not dog-slow like the old one.</p>
<p>In an ideal world we’d have a spare Mini ready to go, but that’s money we don’t have.</p>
<h4>Arq</h4>
<p>The Mini’s internal drive is backed up to S3. The <a href="https://aws.amazon.com/s3/storage-classes/#Infrequent_Access">infrequent access</a> storage class is used to keep the costs down, but using S3 over Glacier means we can restore files quickly.</p>
<p>The current year’s archive and last year’s are also kept in S3, because if the archive drives die we’re more likely to need more recent editions.</p>
<p>All of the archives are kept in <a href="https://aws.amazon.com/s3/storage-classes/#Amazon_Glacier">Glacier</a>, but the modern storage class rather than the legacy vaults. This includes the years that are kept in S3, so that we don’t suddenly have to upload 350GB of stuff as we remove them from the more expensive storage.</p>
<p>I’m slowly removing the legacy Glacier vaults, but it takes forever. You first have to empty the vault, then wait some time so you can actually remove the vault from the list in the management console. I use <a href="https://github.com/leeroybrun/glacier-vault-remove">Leeroy Brun’s glacier-vault-remove</a> tool, to which I had to make a minor change for it to work with Python 3.6 but it was straightforward to get running. (I think it was a missing <code>str.encode()</code> or something. Yes, I know, I should submit a pull request. But it was a one-second job.)</p>
<p>Depending on the size of your vaults, be prepared to have the script run for a long time — this is because of the way that Glacier works (slowly). It took a couple of days for me to remove a 1.5TB-ish vault, followed by a little wait (because the vault had been “recently accessed” — to create the inventory for deletion).</p>
<p>Arq’s ability to set hours during which backups should be paused is great — I could easily ensure our internet connection was fully available during the busiest part of the day.</p>
<p>These are set per-destination (good!) but if one destination is mid-backup and paused, your backups to other destinations won’t run. Consider this case:</p>
<ul>
<li>Our archive is being backed up to Glacier.</li>
<li>Archive backup is paused between 3pm and 7pm.</li>
<li>Backups of the server’s internal drive won’t run during 3pm to 7pm because the archive backup is “ongoing” — even if it is paused.</li>
</ul>
<p>What that meant in practice is that the internal drive wasn’t being backed up to S3 hourly during the (weeks-long) archive backup, except if “Stop backup” is pressed during the pause interval to allow other destinations to backup.</p>
<p>Ideally, paused backups would be put to one side during that window of time and other destinations allowed to run.</p>
<h4>Backblaze</h4>
<p>Our initial 3.5TB <a href="https://secure.backblaze.com/r/010t3l">Backblaze</a> (Star affiliate link) backup is still ongoing, at about 50GB a day over one of our two 17mbps-up fibre lines. In all it’ll have taken a couple of months, compared to a couple of weeks for Arq to S3 &amp; Glacier.</p>
<p>One thing I’ve noticed from personal use at home is that Arq has no qualms about using your entire bandwidth, whereas Backblaze does seem to try not to clog your whole connection. That’s fine at home, but at work with more than one line it matters less.</p>
<p>I was hesitant to write this post up before we’re all set with Backblaze, but it’s got about a week to run still.</p>
<p>I’m interested in seeing what “continuous” backups means in practice, but the <a href="https://help.backblaze.com/hc/en-us/articles/217666288-Schedule-Settings-Mac-">scheduling help page</a> says: “For most computers, this results in roughly 1 backup per hour.” The important thing for me is having an additional regular remote backup separate to Arq (mostly paranoia).</p>
<h3>Enhancements?</h3>
<p>Were money no object, I have some ideas for improvements.</p>
<p>First would be to add <a href="https://cloud.google.com/storage/">Google Cloud Storage</a> as an Arq backup destination, replicating our S3-IA/Glacier split with Google’s <a href="https://cloud.google.com/storage/archival/">Nearline/Coldline</a> storage. It would “just” give us an additional Arq backup, not dependent on AWS.</p>
<p>A big reason why I added Backblaze is to have a remote backup that neither relied on AWS nor Arq. (That’s really not to say that I don’t trust Arq, it’s an eggs-in-one-basket thing.)</p>
<p>Next I’d add an additional Time Machine drive (for a total of three). Running every 20 minutes means that the load on each drive is 50% higher over two hours than the ordinary one backup per hour. Adding a third drive would mean that each drive is being backed up only once per hour. And it would also mean that there is backup history stored on <em>two</em> drives should one fail.</p>
<p>An external SSD to hold a SuperDuper clone is tempting, for the speed and because it might mean that we could continue to use the Mini as usual until we could get the internal drive replaced. (Though that might well be a bad idea.) Our server contains nowhere near its 1TB capacity, so we might get away with a smaller SSD.</p>
<p>And, maybe, instead of extra drives for RAID mirrors (as discussed above), a network-attached storage (NAS) device. But I have no experience with them nor any idea about how best to make use of one. And they seem to be a bit of a black box to me, and a major goal for our setup (Mac Mini, external drives, GUI backup programs) is to be reasonably understandable to any member of production staff — after all, we’re all journalists, not IT workers.</p>
  </article>
  <div class="pagination">
<p class="pagination-older"><a href="https://robjwells.github.io/page-5/">Older posts</a></p><p class="pagination-newer"><a href="https://robjwells.github.io/page-3/">Newer posts</a></p>  </div>

</main>

<footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> <!-- .site-footer -->

</div> <!-- .wrapper -->

</body>

</html>